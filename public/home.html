<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Evaluation Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-role {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        .user-name {
            color: #1f2937;
            font-weight: 500;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background-color: #f3f4f6;
        }

        .navigation {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
        }

        .nav-tabs {
            display: flex;
            gap: 32px;
        }

        .nav-tab {
            padding: 16px 0;
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }

        .nav-tab.active {
            color: #1f2937;
            border-bottom-color: #3b82f6;
        }

        .nav-tab:hover {
            color: #1f2937;
        }

        /* Tab Content Styles */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }


        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .questions-container {
            width: 100%;
        }

        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .questions-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .questions-stats {
            color: #6b7280;
            font-size: 14px;
        }

        .questions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            width: 100%;
        }

        .questions-grid:has(.question-card:only-child) {
            grid-template-columns: repeat(3, 1fr);
            width: 100%;
        }

        /* Fallback for browsers that don't support :has() */
        .questions-grid.single-question {
            grid-template-columns: repeat(3, 1fr);
            width: 100%;
        }

        .question-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-width: 350px;
        }

        .question-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .question-description {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .image-section {
            margin-bottom: 24px;
        }

        .section-label {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .input-image-placeholder {
            width: calc(100% - 48px);
            aspect-ratio: 1;
            background-color: #f8fafc;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
            overflow: hidden;
            margin: 0 16px;
        }

        .input-image-placeholder:hover {
            border-color: #3b82f6;
        }

        .input-image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            transition: transform 0.2s;
        }

        .input-image-placeholder:hover img {
            transform: scale(1.02);
        }

        .output-images {
            display: none; /* Hidden output images */
        }

        .output-image-placeholder {
            aspect-ratio: 1;
            background-color: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 12px;
            cursor: pointer;
            transition: border-color 0.2s;
            overflow: hidden;
        }

        .output-image-placeholder:hover {
            border-color: #3b82f6;
        }

        .output-image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
            transition: transform 0.2s;
        }

        .output-image-placeholder:hover img {
            transform: scale(1.05);
        }

        .evaluate-btn {
            width: 100%;
            background-color: #1f2937;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .evaluate-btn:hover {
            background-color: #111827;
        }

        .re-evaluate-btn {
            background-color: #059669;
        }

        .re-evaluate-btn:hover {
            background-color: #047857;
        }



        /* Questions Table Styles */
        .questions-container {
            padding: 24px;
        }

        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .questions-header h2 {
            margin: 0;
            color: #1f2937;
        }

        .add-btn {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-btn:hover {
            background-color: #059669;
        }

        .questions-table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .questions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .questions-table th {
            background-color: #f9fafb;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .questions-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }

        .questions-table tr:hover {
            background-color: #f9fafb;
        }

        .question-prompt-cell {
            max-width: 300px;
            word-wrap: break-word;
        }

        .question-image {
            width: 120px;
            height: auto;
            max-height: 120px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid #e5e7eb;
        }

        .question-image:hover {
            transform: scale(1.05);
            border-color: #3b82f6;
        }

        .output-images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            max-width: 240px;
        }

        .output-image {
            width: 100%;
            height: auto;
            max-height: 80px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid #e5e7eb;
        }

        .output-image:hover {
            transform: scale(1.05);
            border-color: #3b82f6;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-deleted {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .delete-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .delete-btn:hover {
            background-color: #dc2626;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            color: #1f2937;
        }

        .close {
            color: #6b7280;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #374151;
        }

        .form-group {
            margin-bottom: 20px;
            padding: 0 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .output-image-input {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .output-input-row {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .output-input-row input {
            flex: 1;
        }

        .output-input-row input[type="url"] {
            flex: 2;
        }

        .output-input-row input[type="text"] {
            flex: 1;
        }

        .remove-output-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .add-output-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
        }

        .submit-btn {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .cancel-btn {
            background-color: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Image Modal Styles */
        .image-modal-content {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
            height: auto;
        }

        .image-modal-body {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            min-height: 400px;
        }

        .image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: calc(100% - 120px);
        }

        .image-container img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-btn {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .prev-btn {
            left: 20px;
        }

        .next-btn {
            right: 20px;
        }

        .nav-btn:disabled {
            background-color: rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
        }

        .image-modal-footer {
            padding: 16px 24px;
            text-align: center;
            border-top: 1px solid #e5e7eb;
            background-color: #f9fafb;
        }

        #imageCounter {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        /* Full Screen Modal Styles */
        .fullscreen-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
        }

        .fullscreen-overlay {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .fullscreen-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
        }

        .fullscreen-close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .fullscreen-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .fullscreen-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 80px 60px 60px 60px;
            overflow: hidden;
            background-color: #000000;
        }

        .fullscreen-image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: #000000;
        }

        .fullscreen-image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            background-color: #000000;
            object-fit: contain;
            display: block;
        }

        .fullscreen-nav-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            backdrop-filter: blur(10px);
            z-index: 1002;
        }

        .fullscreen-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .fullscreen-nav-btn.prev-btn {
            left: 10px;
        }

        .fullscreen-nav-btn.next-btn {
            right: 10px;
        }

        .fullscreen-nav-btn:disabled {
            background-color: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: translateY(-50%) scale(1);
        }

        .fullscreen-footer {
            padding: 20px 30px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        #fullScreenCounter {
            color: white;
            font-size: 16px;
            font-weight: 500;
        }

        /* Ensure images display at their natural aspect ratio */
        .fullscreen-image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        /* Preview Modal Styles */
        .preview-container {
            display: flex;
            height: 100%;
            gap: 24px;
            padding: 20px 60px;
            background-color: #000000;
            position: relative;
            z-index: 1;
        }

        .preview-left {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .preview-right {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-image-section,
        .output-images-section {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .input-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000000;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .preview-input-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .preview-input-image:hover {
            transform: scale(1.02);
        }

        .no-image-placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
            text-align: center;
            padding: 40px;
        }

        .output-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, max-content));
            gap: 16px;
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            background-color: #000000;
            justify-content: start;
        }

        .output-item {
            background: #000000;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: fit-content;
            height: fit-content;
        }

        .output-item:hover {
            background: #111111;
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .output-item.highlighted {
            background: #1a1a1a;
            border-color: #4a9eff;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
        }

        .preview-input-image.highlighted {
            border: 3px solid #4a9eff;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
        }

        .preview-output-image {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .output-item:hover .preview-output-image {
            transform: scale(1.05);
        }


        /* Responsive design for preview */
        @media (max-width: 768px) {
            .preview-container {
                flex-direction: column;
                gap: 16px;
            }
            
            .preview-left,
            .preview-right {
                flex: none;
            }
            
            .input-image-container {
                min-height: 250px;
            }
            
            .output-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }
            
            .preview-output-image {
                height: 120px;
            }
        }

        .icon {
            width: 16px;
            height: 16px;
        }

        @media (max-width: 768px) {
            .questions-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                gap: 16px;
                overflow-x: auto;
            }
            
            .header {
                padding: 12px 16px;
            }
            
            .main-content {
                padding: 16px;
            }
        }
        /* Thêm vào CSS hiện có */
        .preview-input-image,
        .preview-output-image,
        .output-image-placeholder img,
        .question-image,
        .output-image {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: high-quality;
            transform: translateZ(0); /* Hardware acceleration */
        }

        /* Progressive loading effect */
        .image-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        /* Lazy loading styles - tối ưu cao */
        .lazy {
            opacity: 0;
            transition: opacity 0.3s ease;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            will-change: transform;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        .lazy.loaded {
            opacity: 1;
            animation: none;
            background: none;
        }

        /* Image optimization styles */
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
            transition: opacity 0.3s ease;
        }

        /* Progressive loading effect */
        .image-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        /* Image container optimization */
        .image-placeholder {
            contain: layout style paint;
            content-visibility: auto;
        }

        .image-placeholder img {
            contain: layout style paint;
            content-visibility: auto;
        }

        /* Filter Section Styles - Modern Design */
        .filter-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .filter-section:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .filter-row {
            display: flex;
            align-items: end;
            gap: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            flex: 1;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            background-color: white;
            color: #374151;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .filter-select:hover {
            border-color: #9ca3af;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .filter-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .filter-btn:hover::before {
            left: 100%;
        }

        .filter-btn:not(.clear-btn) {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
        }

        .filter-btn:not(.clear-btn):hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.6);
        }

        .filter-btn.clear-btn {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(107, 114, 128, 0.4);
        }

        .filter-btn.clear-btn:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(107, 114, 128, 0.6);
        }

        .filter-btn:active {
            transform: translateY(0);
        }

        .filter-btn.loading {
            position: relative;
            color: transparent;
        }

        .filter-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Filter */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }
            
            .filter-group {
                min-width: auto;
            }
            
            .filter-actions {
                justify-content: center;
            }
        }

        /* Pagination Styles - Modern Design */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 32px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .pagination-btn {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 44px;
            text-align: center;
        }

        .pagination-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .pagination-btn:hover::before {
            left: 100%;
        }

        .pagination-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.4);
        }

        .pagination-btn:disabled {
            color: #9ca3af;
            cursor: not-allowed;
            background: #f9fafb;
            border-color: #e5e7eb;
            transform: none;
            box-shadow: none;
        }

        .pagination-btn:disabled::before {
            display: none;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
        }

        .pagination-info {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            margin: 0 16px;
            padding: 8px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .pagination-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .pagination-input-group span {
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pagination-input-group input {
            width: 50px;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination-input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .pagination-go-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-go-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px 0 rgba(16, 185, 129, 0.4);
        }

        .pagination-btn.loading {
            position: relative;
            color: transparent;
        }

        .pagination-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive Pagination */
        @media (max-width: 768px) {
            .pagination {
                flex-wrap: wrap;
                gap: 8px;
                padding: 16px;
            }
            
            .pagination-btn {
                padding: 10px 16px;
                font-size: 12px;
                min-width: 40px;
            }
            
            .pagination-info {
                margin: 0 8px;
                font-size: 12px;
            }
            
            .pagination-input-group {
                padding: 6px 12px;
            }
            
            .pagination-input-group input {
                width: 40px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .pagination {
                flex-direction: column;
                gap: 12px;
            }
            
            .pagination-btn {
                width: 100%;
                max-width: 200px;
            }
        }

        /* Image optimization */
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            overflow: hidden;
        }

        .preview-modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .preview-gallery-container {
            display: flex;
            width: 100%;
            max-width: 1400px;
            height: 80vh;
            gap: 20px;
            align-items: stretch;
        }

        .preview-left-panel {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
        }

        .preview-right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
        }

        .preview-section-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .preview-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 6px;
            background-color: #2a2a2a;
        }

        .preview-modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .preview-modal-image:hover {
            transform: scale(1.02);
        }

        .preview-outputs-grid {
            display: none; /* Hidden output images in preview */
        }

        .preview-output-item {
            display: flex;
            flex-direction: column;
            background-color: #2a2a2a;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .preview-output-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .preview-output-item.active {
            border: 2px solid #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .preview-output-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .preview-output-label {
            padding: 8px;
            color: white;
            font-size: 12px;
            text-align: center;
            background-color: #333;
        }

        .preview-close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1001;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .preview-close-modal:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .preview-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: background-color 0.2s;
        }

        .preview-nav:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .preview-nav.prev {
            left: 20px;
        }

        .preview-nav.next {
            right: 20px;
        }

        .preview-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .preview-full-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }

        .preview-full-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .preview-close-full-image {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1003;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .preview-close-full-image:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Responsive design for preview */
        @media (max-width: 1024px) {
            .preview-gallery-container {
                flex-direction: column;
                height: 90vh;
            }
            
            .preview-left-panel {
                flex: 0 0 30%;
            }
            
            .preview-outputs-grid {
                display: none; /* Hidden output images */
            }
        }

        @media (max-width: 768px) {
            .preview-outputs-grid {
                display: none; /* Hidden output images */
            }
            
            .preview-gallery-container {
                height: 85vh;
            }
            
            .preview-left-panel {
                flex: 0 0 40%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="header-title">Image Evaluation Dashboard</h1>
        <div class="user-info">
            <div class="user-role">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                </svg>
                <!-- <span>Administrator</span> -->
                <span class="user-name">Admin</span>
            </div>
            <a href="#" class="logout-btn" onclick="logout()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                </svg>
                Logout
            </a>
        </div>
    </header>

     <!-- <nav class="navigation">
        <div class="nav-tabs">
            <a href="#" class="nav-tab active" data-tab="questions">Evaluate</a>
        </div>
    </nav> -->

    <main class="main-content">
        <!-- Questions Tab Content -->
        <div class="tab-content active" id="questionsTab">
            <div class="questions-container">
                <div class="questions-header">
                    <h2>Evaluate Questions</h2>
                    <!-- <div class="questions-stats">
                        <span id="totalQuestions">Loading...</span> questions
                    </div> -->
                </div>

                <!-- Filter Section for Questions -->
                <div class="filter-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="questionStatusFilter">Filter by Status:</label>
                            <select id="questionStatusFilter" class="filter-select">
                                <option value="all">All</option>
                                <option value="done">Done</option>
                                <option value="in_progress">In Progress</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button id="applyQuestionFilter" class="filter-btn">Apply Filter</button>
                            <button id="clearQuestionFilter" class="filter-btn clear-btn">Clear Filter</button>
                        </div>
                    </div>
                </div>

            <div class="questions-grid" id="questionsGrid">
                <!-- Questions will be loaded dynamically from server -->
                <div class="loading-placeholder">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="margin-bottom: 16px;">
                            <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 32px; height: 32px;">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        </div>
                        <div>Loading questions...</div>
                    </div>
                </div>
                    </div>
                </div>

        


      

    </main>

    <!-- Image Modal -->
    <div id="imageModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);">
        <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <img id="modalImage" src="" alt="Enlarged Image" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
            <button onclick="closeImageModal()" style="position: absolute; top: 20px; right: 30px; color: white; font-size: 28px; font-weight: bold; background: none; border: none; cursor: pointer;">&times;</button>
        </div>
    </div>

    <div id="previewModal" class="preview-modal">
        <div class="preview-modal-content">
            <button class="preview-close-modal" onclick="closePreviewModal()">&times;</button>
            
            <button class="preview-nav prev" onclick="navigatePreviewImage(-1)">&lt;</button>
            <button class="preview-nav next" onclick="navigatePreviewImage(1)">&gt;</button>
            
            <div class="preview-gallery-container">
                <div class="preview-left-panel">
                    <div class="preview-section-title">Input Image</div>
                    <div class="preview-image-container">
                        <img id="previewInputImage" class="preview-modal-image" src="" alt="Input Image" onclick="showPreviewFullImage(this.src, 'Input Image')">
                    </div>
                </div>
                
                <!-- Output Images panel removed -->
            </div>
        </div>
    </div>
    <div id="previewFullImageModal" class="preview-full-image">
        <button class="preview-close-full-image" onclick="closePreviewFullImage()">&times;</button>
        <img id="previewFullImage" src="" alt="Full Size Image">
    </div>


    <script src="/auth.js"></script>
    <script>
        // Kiểm tra authentication ngay khi script được load
        if (!Auth.checkAuthOnPageLoad()) {
            // Nếu không authenticated, Auth.checkAuthOnPageLoad() sẽ redirect
            // và code dưới đây sẽ không được thực thi
            throw new Error('Authentication required');
        }

        // Global variables
        let questions = [];
        let currentUser = null;
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 9;
        let maxOutputs = 0;
        let currentFilters = { userId: 'all', questionId: 'all', status: 'all' };
        let currentQuestionFilters = { status: 'all' };
        let previewCurrentQuestion = null;
        let previewCurrentImageIndex = 0;
        let previewAllImages = [];

        // Intersection Observer for advanced lazy loading
        let imageObserver = null;
        
        // Function declaration - hoisted
        function initImageObserver() {
            if ('IntersectionObserver' in window) {
                imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                                img.classList.remove('lazy');
                                imageObserver.unobserve(img);
                            }
                        }
                    });
                }, {
                    rootMargin: '100px 0px', // Load sớm hơn
                    threshold: 0.01,
                    trackVisibility: true, // Tối ưu performance
                    delay: 100 // Batch operations
                });
            }
        }

        // Load questions from server when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Starting initialization...');
            
            // Initialize image observer for lazy loading
            initImageObserver();
            
            await loadUserInfo();
            loadQuestions();
        });

        // Function to load and display user information
        async function loadUserInfo() {
            console.log('loadUserInfo called');
            
            // Get user info from sessionStorage (set during login)
            const userInfo = sessionStorage.getItem('userInfo');
            if (userInfo) {
                try {
                    currentUser = JSON.parse(userInfo);
                    console.log('User from sessionStorage:', currentUser);
                    
                    const userNameElement = document.querySelector('.user-name');
                    if (userNameElement && currentUser.name) {
                        userNameElement.textContent = currentUser.name;
                    }
                    
                    // Load fresh user data from server to get latest experience and qualification
                    await loadFreshUserData();
                    
                    // Always load profile information to display current state
                    loadProfileInfo();
                    
                    // Check if user needs to complete profile
                    if (!currentUser.experience || !currentUser.qualification) {
                        showProfileCompletionModal();
                    }
                    
                    // Setup tab navigation (this will hide admin tabs for non-admin users)
                    setupTabNavigation();
                    
                    // Hide admin-only tab contents for non-admin users
                    const isAdmin = currentUser && currentUser.role === 'admin';
                    if (!isAdmin) {
                        const adminTabContents = ['responsesTab', 'adminTab'];
                        adminTabContents.forEach(tabId => {
                            const tabContent = document.getElementById(tabId);
                            if (tabContent) {
                                tabContent.style.display = 'none';
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error parsing userInfo:', error);
                    redirectToLogin();
                }
            } else {
                console.log('No user info in sessionStorage, redirecting to login');
                redirectToLogin();
            }
        }

        // Function to redirect to login page
        function redirectToLogin() {
            console.log('Redirecting to login page...');
            window.location.href = '/login.html';
        }

        // Function to test login (for debugging)
        async function testLogin() {
            try {
                console.log('Testing login with admin/admin...');
                const response = await fetch('https://surveyform-kxkk.onrender.com/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Login successful:', data);
                    
                    // Set sessionStorage
                    sessionStorage.setItem('userInfo', JSON.stringify(data.user));
                    console.log('User info saved to sessionStorage');
                    
                    // Reload page to test
                    window.location.reload();
                } else {
                    const errorData = await response.json();
                    console.log('Login failed:', response.status, errorData);
                }
            } catch (error) {
                console.error('Error testing login:', error);
                console.log('Make sure server is running on https://surveyform-kxkk.onrender.com');
            }
        }

        // Function to manually set user data (for testing)
        function setTestUserData() {
            const testUser = {
                _id: "test123",
                username: "admin",
                name: "Admin User",
                experience: "5 years in image evaluation",
                qualification: "Master's degree in Computer Science"
            };
            
            sessionStorage.setItem('userInfo', JSON.stringify(testUser));
            console.log('Test user data set:', testUser);
            
            // Update current user and display immediately
            currentUser = testUser;
            
            // Update user name in header
            const userNameElement = document.querySelector('.user-name');
            if (userNameElement) {
                userNameElement.textContent = testUser.name;
            }
            
            console.log('Profile updated with test data');
        }

        // Function to clear session and start fresh
        function clearSession() {
            sessionStorage.clear();
            localStorage.clear();
            currentUser = null;
            console.log('Session cleared');
            
            // Update display to show "Not specified"
            
            // Clear user name in header
            const userNameElement = document.querySelector('.user-name');
            if (userNameElement) {
                userNameElement.textContent = 'Guest';
            }
        }

        // Make functions available globally for console testing
        window.testLogin = testLogin;
        window.setTestUserData = setTestUserData;
        window.clearSession = clearSession;



        // Function to load fresh user data from server
        async function loadFreshUserData() {
            try {
                if (!currentUser) {
                    console.log('No current user, cannot load fresh data');
                    return;
                }
                
                // Try different ways to identify user
                let userId = currentUser._id || currentUser.id;
                if (!userId && currentUser.username) {
                    userId = currentUser.username;
                }
                
                if (!userId) {
                    console.log('No user ID or username found, cannot load fresh data');
                    return;
                }
                
                console.log('Loading fresh user data from server for:', userId);
                
                const response = await fetch(`https://surveyform-kxkk.onrender.com/debug-user/${userId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.user) {
                        // Update current user with fresh data from server
                        currentUser = { ...currentUser, ...data.user };
                        sessionStorage.setItem('userInfo', JSON.stringify(currentUser));
                        console.log('Fresh user data loaded:', currentUser);
                        console.log('Experience:', currentUser.experience);
                        console.log('Qualification:', currentUser.qualification);
                    } else {
                        console.log('No user data returned from server');
                    }
                } else {
                    console.log('Failed to load user data from server:', response.status, response.statusText);
                    // Don't redirect here, just log the error
                }
            } catch (error) {
                console.error('Error loading fresh user data:', error);
            }
        }

        // Function to load user data from server
        async function loadUserFromServer() {
            try {
                // Try to get username from any available source
                let username = null;
                
                // Check if we have any user info
                const userInfo = sessionStorage.getItem('userInfo');
                if (userInfo) {
                    try {
                        const user = JSON.parse(userInfo);
                        username = user.username;
                    } catch (e) {
                        console.error('Error parsing userInfo:', e);
                    }
                }
                
                // If no username, try to get from localStorage or other sources
                if (!username) {
                    username = localStorage.getItem('username') || 'admin'; // fallback
                }
                
                console.log('Trying to load user data for username:', username);
                
                const response = await fetch(`https://surveyform-kxkk.onrender.com/debug-user/${username}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.user) {
                        currentUser = data.user;
                        sessionStorage.setItem('userInfo', JSON.stringify(currentUser));
                        console.log('User data loaded from server:', currentUser);
                    }
                }
            } catch (error) {
                console.error('Error loading user from server:', error);
            }
        }

                // Function to load profile information
        function loadProfileInfo() {
            if (!currentUser) {
                console.log('No current user, cannot load profile info');
                return;
            }

            console.log('Loading profile info for user:', currentUser);
            console.log('Experience:', currentUser.experience);
            console.log('Qualification:', currentUser.qualification);

            // Update profile elements
            const profileName = document.getElementById('profileName');
            const profileUsername = document.getElementById('profileUsername');
            const profileExperience = document.getElementById('profileExperience');
            const profileQualification = document.getElementById('profileQualification');
            
            console.log('Profile elements found:', {
                profileName: !!profileName,
                profileUsername: !!profileUsername,
                profileExperience: !!profileExperience,
                profileQualification: !!profileQualification
            });
            
            if (profileName) {
                profileName.textContent = currentUser.name || 'Not specified';
            }
            if (profileUsername) {
                profileUsername.textContent = currentUser.username || 'Not specified';
            }
            if (profileExperience) {
                const experienceText = currentUser.experience || 'Not specified';
                profileExperience.textContent = experienceText;
                console.log('Updated profileExperience with:', experienceText);
            }
            if (profileQualification) {
                const qualificationText = currentUser.qualification || 'Not specified';
                profileQualification.textContent = qualificationText;
                console.log('Updated profileQualification with:', qualificationText);
            }
            
        }

        // Function to start editing a field
        function startEdit(fieldName) {
            const editForm = document.getElementById(fieldName + 'EditForm');
            const editableContent = document.querySelector(`#profile${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`).parentElement;
            const textarea = document.getElementById(fieldName + 'EditTextarea');
            const currentValue = currentUser[fieldName] || '';
            
            // Set current value in textarea
            textarea.value = currentValue;
            
            // Hide the current content
            editableContent.style.display = 'none';
            
            // Show edit form
            editForm.classList.add('active');
            
            // Focus on textarea
            textarea.focus();
            
            // Auto-resize textarea
            autoResizeTextarea(textarea);
        }

        // Function to save edit
        async function saveEdit(fieldName) {
            const textarea = document.getElementById(fieldName + 'EditTextarea');
            const newValue = textarea.value.trim();
            
            if (!newValue) {
                alert('Please enter a value for ' + fieldName);
                return;
            }
            
            // Disable save button to prevent double submission
            const saveBtn = textarea.parentElement.querySelector('.save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                // Prepare update data
                const updateData = {
                    experience: currentUser.experience || '',
                    qualification: currentUser.qualification || ''
                };
                updateData[fieldName] = newValue;
                
                // Call save function
                const success = await saveProfileInfo(updateData.experience, updateData.qualification);
                
                if (success) {
                    // Update local display
                    const displayElement = document.getElementById('profile' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1));
                    displayElement.textContent = newValue;
                    
                    // Hide edit form and show updated content
                    const editForm = document.getElementById(fieldName + 'EditForm');
                    const editableContent = document.querySelector(`#profile${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`).parentElement;
                    
                    editForm.classList.remove('active');
                    editableContent.style.display = 'block';
                    
                    alert(fieldName.charAt(0).toUpperCase() + fieldName.slice(1) + ' updated successfully!');
                }
            } catch (error) {
                console.error('Error saving edit:', error);
                alert('Failed to save changes. Please try again.');
            } finally {
                // Re-enable save button
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // Function to cancel edit
        function cancelEdit(fieldName) {
            const editForm = document.getElementById(fieldName + 'EditForm');
            const editableContent = document.querySelector(`#profile${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`).parentElement;
            const textarea = document.getElementById(fieldName + 'EditTextarea');
            
            // Clear textarea
            textarea.value = '';
            
            // Hide edit form
            editForm.classList.remove('active');
            
            // Show the current content again
            editableContent.style.display = 'block';
        }

        // Function to auto-resize textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Add event listeners for textarea auto-resize
        document.addEventListener('DOMContentLoaded', function() {
            const textareas = document.querySelectorAll('.edit-textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
            });
        });

        // Function to setup tab navigation
        function setupTabNavigation() {
            const navTabs = document.querySelectorAll('.nav-tab');
            
            // Check if current user is admin
            const isAdmin = currentUser && currentUser.role === 'admin';
            
            // Hide admin-only tabs for non-admin users
            navTabs.forEach(tab => {
                const tabType = tab.getAttribute('data-tab');
                if (['responses', 'admin', 'users'].includes(tabType) && !isAdmin) {
                    tab.style.display = 'none';
                }
            });
            
            navTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all tabs
                    navTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all tab contents
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Show selected tab content
                    const targetTab = this.getAttribute('data-tab');
                    const targetContent = document.getElementById(targetTab + 'Tab');
                    if (targetContent) {
                        targetContent.classList.add('active');
                        
                        // Load responses when switching to responses tab
                        if (targetTab === 'responses') {
                            loadFilterData();
                            loadAllResponses();
                        }
                        
                        // Load questions when switching to admin tab
                        if (targetTab === 'admin') {
                            loadAllQuestions();
                        }
                        
                    }
                });
            });
        }

        // Function to show profile completion modal
        async function showProfileCompletionModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Debug user info first
            await debugUserInfo();
            
            // Pre-fill existing data if available
            if (currentUser.experience) {
                document.getElementById('experience').value = currentUser.experience;
            }
            if (currentUser.qualification) {
                document.getElementById('qualification').value = currentUser.qualification;
            }
        }

        // Function to hide profile completion modal
        function hideProfileCompletionModal() {
            const modal = document.getElementById('profileModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Function to debug user info
        async function debugUserInfo() {
            try {
                const userId = currentUser._id || currentUser.username;
                const response = await fetch(`https://surveyform-kxkk.onrender.com/debug-user/${userId}`);
                const data = await response.json();
                console.log('Debug user info:', data);
                return data;
            } catch (error) {
                console.error('Error debugging user:', error);
                return null;
            }
        }

        // Function to refresh user data from server
        async function refreshUserData() {
            try {
                const userId = currentUser._id || currentUser.username;
                const response = await fetch(`https://surveyform-kxkk.onrender.com/debug-user/${userId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.user) {
                        // Update current user with fresh data from server
                        currentUser = { ...currentUser, ...data.user };
                        sessionStorage.setItem('userInfo', JSON.stringify(currentUser));
                        console.log('User data refreshed from server:', currentUser);
                    }
                }
            } catch (error) {
                console.error('Error refreshing user data:', error);
            }
        }

        // Function to save profile information
        async function saveProfileInfo(experience, qualification) {
            try {
                console.log('Current user data:', currentUser);
                
                // Try to use _id first, fallback to username
                const userId = currentUser._id || currentUser.username;
                
                const requestBody = {
                    userId: userId,
                    experience: experience,
                    qualification: qualification
                };
                
                console.log('Sending update request:', requestBody);
                
                const response = await fetch('https://surveyform-kxkk.onrender.com/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const responseData = await response.json();
                console.log('Server response:', responseData);

                if (response.ok) {
                    // Update local user data
                    currentUser.experience = experience;
                    currentUser.qualification = qualification;
                    
                    // Update sessionStorage
                    sessionStorage.setItem('userInfo', JSON.stringify(currentUser));
                    
                    // Refresh user data from server to ensure consistency
                    await refreshUserData();
                    
                    // Hide modal and load profile
                    hideProfileCompletionModal();
                    loadProfileInfo();
                    
                    return true;
                } else {
                    throw new Error(responseData.message || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to save profile information: ' + error.message);
                return false;
            }
        }

        // Setup profile form submission
        document.addEventListener('DOMContentLoaded', function() {
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const experience = document.getElementById('experience').value.trim();
                    const qualification = document.getElementById('qualification').value.trim();
                    
                    if (!experience || !qualification) {
                        alert('Please fill in both experience and qualification fields.');
                        return;
                    }
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = this.querySelector('.submit-btn');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';
                    
                    try {
                        const success = await saveProfileInfo(experience, qualification);
                        if (success) {
                            alert('Profile updated successfully!');
                        }
                    } finally {
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Setup filter event listeners
            const applyFilterBtn = document.getElementById('applyFilter');
            const clearFilterBtn = document.getElementById('clearFilter');
            
            if (applyFilterBtn) {
                applyFilterBtn.addEventListener('click', function() {
                    const userFilter = document.getElementById('userFilter');
                    const questionFilter = document.getElementById('questionFilter');
                    
                    currentFilters.userId = userFilter.value;
                    currentFilters.questionId = questionFilter.value;
                    
                    // Reset to page 1 when applying filter
                    loadAllResponses(1);
                });
            }
            
            if (clearFilterBtn) {
                clearFilterBtn.addEventListener('click', function() {
                    const userFilter = document.getElementById('userFilter');
                    const questionFilter = document.getElementById('questionFilter');
                    
                    userFilter.value = 'all';
                    questionFilter.value = 'all';
                    
                    currentFilters.userId = 'all';
                    currentFilters.questionId = 'all';
                    
                    // Reset to page 1 when clearing filter
                    loadAllResponses(1);
                });
            }
            
            // Setup question filter event listeners
            const applyQuestionFilterBtn = document.getElementById('applyQuestionFilter');
            const clearQuestionFilterBtn = document.getElementById('clearQuestionFilter');
            
            if (applyQuestionFilterBtn) {
                applyQuestionFilterBtn.addEventListener('click', function() {
                    const questionStatusFilter = document.getElementById('questionStatusFilter');
                    currentQuestionFilters.status = questionStatusFilter.value;
                    loadQuestions();
                });
            }
            
            if (clearQuestionFilterBtn) {
                clearQuestionFilterBtn.addEventListener('click', function() {
                    const questionStatusFilter = document.getElementById('questionStatusFilter');
                    questionStatusFilter.value = 'all';
                    currentQuestionFilters.status = 'all';
                    loadQuestions();
                });
            }
            
            // Setup questions modal event listeners
            // Setup add user modal
            const addUserBtn = document.getElementById('addUserBtn');
            const addUserModal = document.getElementById('addUserModal');
            const closeAddUserModal = document.getElementById('closeAddUserModal');
            const cancelAddUserBtn = document.getElementById('cancelAddUserBtn');
            const addUserForm = document.getElementById('addUserForm');

            if (addUserBtn) {
                addUserBtn.addEventListener('click', function() {
                    addUserModal.style.display = 'block';
                });
            }

            if (closeAddUserModal) {
                closeAddUserModal.addEventListener('click', function() {
                    addUserModal.style.display = 'none';
                });
            }

            if (cancelAddUserBtn) {
                cancelAddUserBtn.addEventListener('click', function() {
                    addUserModal.style.display = 'none';
                });
            }

            // Close modal when clicking outside
            if (addUserModal) {
                addUserModal.addEventListener('click', function(e) {
                    if (e.target === addUserModal) {
                        addUserModal.style.display = 'none';
                    }
                });
            }

            // Setup username generation from name input
            const userNameInput = document.getElementById('userName');
            const userUsernameInput = document.getElementById('userUsername');
            const addUserSubmitBtn = document.getElementById('addUserSubmitBtn');

            if (userNameInput) {
                userNameInput.addEventListener('input', async function() {
                    const name = this.value.trim();
                    
                    if (name.length > 0) {
                        // Generate base username
                        // Generate simple username
                        const finalUsername = name.toLowerCase().replace(/\s+/g, '') + Math.floor(Math.random() * 1000);
                        userUsernameInput.value = finalUsername;
                        
                        // Enable submit button
                        addUserSubmitBtn.disabled = false;
                    } else {
                        userUsernameInput.value = '';
                        addUserSubmitBtn.disabled = true;
                    }
                });
            }

            const addQuestionBtn = document.getElementById('addQuestionBtn');
            const addQuestionModal = document.getElementById('addQuestionModal');
            const closeAddModal = document.getElementById('closeAddModal');
            const cancelAddBtn = document.getElementById('cancelAddBtn');
            const addQuestionForm = document.getElementById('addQuestionForm');
            const addOutputBtn = document.getElementById('addOutputBtn');
            
            if (addQuestionBtn) {
                addQuestionBtn.addEventListener('click', function() {
                    addQuestionModal.style.display = 'block';
                });
            }
            
            if (closeAddModal) {
                closeAddModal.addEventListener('click', function() {
                    addQuestionModal.style.display = 'none';
                });
            }
            
            if (cancelAddBtn) {
                cancelAddBtn.addEventListener('click', function() {
                    addQuestionModal.style.display = 'none';
                });
            }
            
            if (addOutputBtn) {
                addOutputBtn.addEventListener('click', function() {
                    addOutputImageInput();
                });
            }

            // Setup add user form submission
            if (addUserForm) {
                addUserForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const name = formData.get('name').trim();
                    const username = formData.get('username');
                    const role = formData.get('role');
                    const password = formData.get('password');
                    
                    if (!name || !username || !role || !password) {
                        alert('Please fill in all required fields.');
                        return;
                    }
                    
                    try {
                        console.log('Adding user with generated username:', username);
                        
                        const response = await fetch('https://surveyform-kxkk.onrender.com/add-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: name,
                                username: username,
                                role: role,
                                password: password
                            })
                        });
                        
                        if (response.ok) {
                            alert(`User added successfully! Username: ${username}`);
                            addUserModal.style.display = 'none';
                            this.reset();
                            // Reset password field to default value
                            document.getElementById('userPassword').value = 'password123';
                            // Disable submit button
                            document.getElementById('addUserSubmitBtn').disabled = true;
                        } else {
                            const error = await response.json();
                            alert('Error adding user: ' + error.message);
                        }
                    } catch (error) {
                        console.error('Error adding user:', error);
                        alert('Failed to add user. Please try again.');
                    }
                });
            }
            
            if (addQuestionForm) {
                addQuestionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const prompt = formData.get('prompt');
                    const imageInput = formData.get('imageInput');
                    const outputUrls = formData.getAll('outputUrls[]').filter(url => url.trim() !== '');
                    const outputSrcs = formData.getAll('outputSrcs[]').filter(src => src.trim() !== '');
                    
                    if (!prompt || !imageInput || outputUrls.length === 0) {
                        alert('Please fill in all required fields.');
                        return;
                    }
                    
                    if (outputUrls.length !== outputSrcs.length) {
                        alert('Please fill in both URL and Source for all output images.');
                        return;
                    }
                    
                    // Create outputs array with image and src
                    const outputs = outputUrls.map((url, index) => ({
                        image: url,
                        src: outputSrcs[index] || 'Unknown'
                    }));
                    
                    try {
                        const response = await fetch('https://surveyform-kxkk.onrender.com/add-question', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                prompt: prompt,
                                imageInput: imageInput,
                                outputs: outputs
                            })
                        });
                        
                        if (response.ok) {
                            alert('Question added successfully!');
                            addQuestionModal.style.display = 'none';
                            this.reset();
                            loadAllQuestions(); // Reload questions table
                        } else {
                            const error = await response.json();
                            alert('Error adding question: ' + error.message);
                        }
                    } catch (error) {
                        console.error('Error adding question:', error);
                        alert('Failed to add question. Please try again.');
                    }
                });
            }
            
            // Setup image modal event listeners
            const fullScreenModal = document.getElementById('fullScreenModal');
            const closeFullScreenModalBtn = document.getElementById('closeFullScreenModal');
            const fullScreenPrevBtn = document.getElementById('fullScreenPrevBtn');
            const fullScreenNextBtn = document.getElementById('fullScreenNextBtn');
            
            if (closeFullScreenModalBtn) {
                closeFullScreenModalBtn.addEventListener('click', closeImageModal);
            }
            
            if (fullScreenPrevBtn) {
                fullScreenPrevBtn.addEventListener('click', showPreviousImage);
            }
            
            if (fullScreenNextBtn) {
                fullScreenNextBtn.addEventListener('click', showNextImage);
            }
            
            // Close modal when clicking outside
            if (fullScreenModal) {
                fullScreenModal.addEventListener('click', function(e) {
                    if (e.target === fullScreenModal) {
                        closeImageModal();
                    }
                });
            }
            
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (fullScreenModal && fullScreenModal.style.display === 'block') {
                    if (e.key === 'Escape') {
                        closeImageModal();
                    } else if (e.key === 'ArrowLeft') {
                        showPreviousImage();
                    } else if (e.key === 'ArrowRight') {
                        showNextImage();
                    }
                }
            });
        });

        // Function to truncate text to specified length
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) {
                return text;
            }
            
            // Find the last space before maxLength
            const truncated = text.substring(0, maxLength);
            const lastSpaceIndex = truncated.lastIndexOf(' ');
            
            if (lastSpaceIndex > 0) {
                return truncated.substring(0, lastSpaceIndex) + '...';
            } else {
                return truncated + '...';
            }
        }

        // Function to load questions from server with pagination
        async function loadQuestions(page = 1) {
            try {
                console.log('Loading questions for page:', page);
                
                // Get current user info
                const userInfo = sessionStorage.getItem('userInfo');
                let userId = null;
                
                if (userInfo) {
                    const currentUser = JSON.parse(userInfo);
                    userId = currentUser._id || currentUser.username;
                }
                
                // Build URL with pagination and userId parameters
                const url = `https://surveyform-kxkk.onrender.com/questions?page=${page}&limit=${itemsPerPage}&userId=${encodeURIComponent(userId)}&status=${currentQuestionFilters.status}`;
                console.log('URL:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                questions = data.questions || [];
                currentPage = data.pagination?.currentPage || page;
                totalPages = data.pagination?.totalPages || 1;
                
                console.log(`Loaded ${questions.length} questions for page ${currentPage}/${totalPages}`);
                console.log('Pagination info:', data.pagination);
                
                // Debug first question structure
                if (questions.length > 0) {
                    console.log('Debug - First question:', questions[0]);
                    console.log('Debug - First question outputs structure:', questions[0].outputs);
                    console.log('Debug - First question imageInput:', questions[0].imageInput);
                    console.log('Debug - First output item:', questions[0].outputs?.[0]);
                    console.log('Debug - All questions length:', questions.length);
                }
                
                renderQuestions();
                renderQuestionsPagination();
                
                // Update questions stats
                const totalQuestionsElement = document.getElementById('totalQuestions');
                if (totalQuestionsElement) {
                    totalQuestionsElement.textContent = questions.length;
                }
                
                // Preload images for better UX - tối ưu hơn
                const imagesToPreload = [];
                questions.forEach(question => {
                    if (question.imageInput) imagesToPreload.push(question.imageInput);
                    if (question.outputs) {
                        question.outputs.forEach(output => {
                            const imageUrl = typeof output === 'object' ? output.image : output;
                            if (imageUrl) imagesToPreload.push(imageUrl);
                        });
                    }
                });
                
                // Preload images in background
                if (imagesToPreload.length > 0) {
                    preloadImages(imagesToPreload).catch(error => {
                        console.warn('Error preloading images:', error);
                    });
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                showError('Failed to load questions. Please try again later.');
            }
        }

        // Function to render pagination for questions
        function renderQuestionsPagination() {
            const questionsGrid = document.getElementById('questionsGrid');
            
            // Remove existing pagination if any
            const existingPagination = document.getElementById('questionsPagination');
            if (existingPagination) {
                existingPagination.remove();
            }
            
            if (totalPages <= 1) {
                return;
            }
            
            // Create pagination container
            const paginationContainer = document.createElement('div');
            paginationContainer.id = 'questionsPagination';
            paginationContainer.className = 'pagination';
            paginationContainer.style.marginTop = '24px';
            
            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `
                <button class="pagination-btn" onclick="loadQuestions(${currentPage - 1})" 
                        ${currentPage <= 1 ? 'disabled' : ''}>
                    Previous
                </button>
            `;
            
            // Page info
            paginationHtml += `
                <div class="pagination-info">
                    Page ${currentPage} of ${totalPages}
                </div>
            `;
            
            // Page input
            paginationHtml += `
                <div class="pagination-input-group">
                    <span>Go to:</span>
                    <input type="number" id="pageInput" min="1" max="${totalPages}" value="${currentPage}" 
                           onkeypress="if(event.key==='Enter') goToPage()">
                    <button class="pagination-go-btn" onclick="goToPage()">
                        Go
                    </button>
                </div>
            `;
            
            // Next button
            paginationHtml += `
                <button class="pagination-btn" onclick="loadQuestions(${currentPage + 1})" 
                        ${currentPage >= totalPages ? 'disabled' : ''}>
                    Next
                </button>
            `;
            
            paginationContainer.innerHTML = paginationHtml;
            
            // Insert pagination after questions grid
            questionsGrid.parentNode.insertBefore(paginationContainer, questionsGrid.nextSibling);
        }

        // Function to go to specific page
        function goToPage() {
            const pageInput = document.getElementById('pageInput');
            const page = parseInt(pageInput.value);
            
            if (page >= 1 && page <= totalPages) {
                loadQuestions(page);
            } else {
                alert(`Please enter a page number between 1 and ${totalPages}`);
                pageInput.value = currentPage;
            }
        }

        // Function to preload images - tối ưu cao
        function preloadImages(imageUrls) {
            // Chỉ preload 3 ảnh đầu tiên để tăng tốc
            const limitedUrls = imageUrls.slice(0, 3);
            
            const imagePromises = limitedUrls.map(url => {
                if (!url || url.trim() === '') return Promise.resolve();
                
                return new Promise((resolve) => {
                    const img = new Image();
                    
                    // Tối ưu loading
                    img.crossOrigin = 'anonymous';
                    img.loading = 'eager';
                    img.decoding = 'async';
                    img.fetchpriority = 'high';
                    
                    img.onload = () => {
                        console.log('Preloaded image:', url);
                        resolve();
                    };
                    
                    img.onerror = () => {
                        console.warn('Failed to preload image:', url);
                        resolve(); // Don't reject on error
                    };
                    
                    // Set src after setting up handlers
                    img.src = url;
                });
            });
            
            return Promise.all(imagePromises);
        }

        // Function to create lazy image element - tối ưu cao
        function createLazyImage(src, alt, className = '', style = '') {
            const optimizedStyle = `${style} 
                image-rendering: -webkit-optimize-contrast; 
                image-rendering: crisp-edges; 
                transform: translateZ(0); 
                will-change: transform;
                backface-visibility: hidden;
                transition: opacity 0.3s ease;
                opacity: 0;
            `;
            
            if ('IntersectionObserver' in window) {
                return `<img data-src="${src}" alt="${alt}" class="lazy ${className}" style="${optimizedStyle}" loading="lazy" decoding="async" fetchpriority="high">`;
            } else {
                return `<img src="${src}" alt="${alt}" class="${className}" style="${optimizedStyle}" loading="lazy" decoding="async" fetchpriority="high">`;
            }
        }

        // Function to render questions
        function renderQuestions() {
            const questionsGrid = document.getElementById('questionsGrid');
            
            // Apply status filter only if not 'all'
            let filteredQuestions = questions;
            if (currentQuestionFilters.status !== 'all') {
                filteredQuestions = questions.filter(question => {
                    switch (currentQuestionFilters.status) {
                        case 'done':
                            return question.isComplete === true;
                        case 'in_progress':
                            return question.hasAnswered === true && question.isComplete === false;
                        case 'pending':
                            return question.hasAnswered === false;
                        default:
                            return true;
                    }
                });
            }
            // If status is 'all', use all questions without filtering
            
            // Update questions stats
            const totalQuestionsElement = document.getElementById('totalQuestions');
            if (totalQuestionsElement) {
                totalQuestionsElement.textContent = filteredQuestions.length;
            }
            
            if (filteredQuestions.length === 0) {
                questionsGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="margin-bottom: 16px;">
                            <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 32px; height: 32px;">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
            </div>
                        <div>No questions available</div>
                    </div>
                `;
                return;
            }

            // Grid always has 3 columns, no need for special single-question class

            questionsGrid.innerHTML = filteredQuestions.map((question, index) => {
                // Use stt_doc as question number, fallback to pagination calculation
                const questionNumber = question.stt_doc || ((currentPage - 1) * itemsPerPage + index + 1);
                
                return `
                <div class="question-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h2 class="question-title">Request #${questionNumber}</h2>
                            ${question.isComplete ? 
                                '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">✓ Done</span>' : 
                                question.hasAnswered ? 
                                    '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">🔄 In Progress</span>' :
                                    '<span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">⏳ Pending</span>'
                            }
                        </div>
                    <p class="question-description">
                            ${truncateText(question.prompt || 'No description available', 50)}
                    </p>
                    
                    <div class="image-section">
                        <div class="section-label">Input Image:</div>
                            <div class="input-image-placeholder" onclick="showImageModal(${index})">
                                ${question.imageInput && question.imageInput.trim() !== '' ? 
                                    createLazyImage(question.imageInput, "Input Image", '', 
                                        `width: 100%; height: 100%; object-fit: cover; border-radius: 6px;`).replace('>', 
                                        ` onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" 
                                         onload="this.classList.add('loaded'); this.style.opacity='1';">`) :
                                    ''
                                }
                                <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="${question.imageInput && question.imageInput.trim() !== '' ? 'display: none;' : 'display: flex;'}">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Output Images section removed -->

                        <button class="evaluate-btn ${question.isComplete ? 're-evaluate-btn' : ''}" onclick="evaluateImages('${question._id}', ${questionNumber})">
                                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                        ${question.isComplete ? 'Re-Evaluate Images' : 'Evaluate Images'}
                    </button>
                            </div>
                `;
            }).join('');
            
            // Observe lazy images after rendering
            if (imageObserver) {
                const lazyImages = questionsGrid.querySelectorAll('img.lazy');
                lazyImages.forEach(img => imageObserver.observe(img));
            }
        }

        // Function to generate output image placeholders
        function generateOutputImagePlaceholders(outputImages, questionId, questionNumber, questionIndex) {
            console.log('generateOutputImagePlaceholders called:', { outputImages, questionId, questionNumber, questionIndex });
            
            const maxImages = 3;
            const totalImages = outputImages ? outputImages.length : 0;
            let html = '';
            
            console.log('Total output images:', totalImages);
            
            for (let i = 0; i < maxImages; i++) {
                const imageObj = outputImages && outputImages[i] ? outputImages[i] : null;
                console.log(`Processing output ${i}:`, imageObj);
                
                // Handle different output structures
                let imageUrl = '';
                if (imageObj) {
                    if (typeof imageObj === 'string') {
                        imageUrl = imageObj;
                    } else if (imageObj.image) {
                        imageUrl = imageObj.image;
                    } else if (imageObj.url) {
                        imageUrl = imageObj.url;
                    }
                }
                
                const hasImage = imageUrl && imageUrl.trim() !== '';
                const isLastImage = i === maxImages - 1;
                const hasMoreImages = totalImages > maxImages;
                const remainingCount = totalImages - maxImages;
                
                console.log(`Output ${i} - imageUrl: ${imageUrl}, hasImage: ${hasImage}`);
                
                html += `
                    <div class="output-image-placeholder" onclick="showImageModal(${questionIndex})" style="position: relative;">
                        ${hasImage ? 
                            createLazyImage(imageUrl, `Output Image ${i + 1}`, '', 
                                `width: 100%; height: 100%; object-fit: cover; border-radius: 4px;`).replace('>', 
                                ` onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" 
                                 onload="this.classList.add('loaded'); this.style.opacity='1';">`) :
                ''
                        }
                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="${hasImage ? 'display: none;' : 'display: flex;'}">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                        ${isLastImage && hasMoreImages ? `
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                                +${remainingCount}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            console.log('Generated HTML for output images:', html);
            return html;
        }

        // Function to show error message
        function showError(message) {
            const questionsGrid = document.getElementById('questionsGrid');
            questionsGrid.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ef4444;">
                    <div style="margin-bottom: 16px;">
                        <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 32px; height: 32px;">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1 9a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    <div>${message}</div>
                    <button onclick="loadQuestions()" style="margin-top: 16px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Retry
                    </button>
                    </div>
            `;
        }

        // Function to show input image in modal
        function uploadInputImage(questionId, questionNumber) {
            console.log('Show input image for question:', questionId);
            
            // Find the question
            const question = questions.find(q => q._id === questionId);
            if (!question || !question.imageInput) {
                alert('No input image available');
                return;
            }
            
            const modal = document.getElementById('fullScreenModal');
            const modalImage = document.getElementById('fullScreenImage');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Set current images and index
            currentImages = [question.imageInput];
            currentImageIndex = 0;
            
            // Update modal content
            modalImage.src = question.imageInput;
            modalTitle.textContent = `Request #${questionNumber} - Input Image`;
            imageCounter.textContent = '1 / 1';
            
            // Hide navigation buttons for single image
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            
            modal.style.display = 'block';
        }

        // Function to view output image
        function viewOutputImage(questionId, imageIndex, questionNumber) {
            console.log('View output image:', questionId, imageIndex);
            
            // Find the question
            const question = questions.find(q => q._id === questionId);
            if (!question) {
                alert('Question not found');
                return;
            }
            
            const totalImages = question.outputs.length;
            const maxImages = 3;
            
            // If clicking on the last image and there are more images, show the last actual image
            if (imageIndex === maxImages - 1 && totalImages > maxImages) {
                imageIndex = totalImages - 1; // Show the last actual image
            }
            
            // Show single image in modal with navigation
            const imageObj = question.outputs[imageIndex];
            const imageUrl = imageObj && imageObj.image ? imageObj.image : '';
            if (imageUrl) {
                showImageModalWithNavigation(question.outputs, imageIndex, questionId, questionNumber);
            } else {
                alert('No image available');
            }
        }

        // Function to show image in modal
        function showImageModal(imageUrl, title) {
            const modal = document.getElementById('fullScreenModal');
            const modalImage = document.getElementById('fullScreenImage');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Set current images and index
            currentImages = [imageUrl];
            currentImageIndex = 0;
            
            // Update modal content
            modalImage.src = imageUrl;
            modalTitle.textContent = title;
            imageCounter.textContent = '1 / 1';
            
            // Hide navigation buttons for single image
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            
            modal.style.display = 'block';
        }

        // Function to show image modal with navigation
        function showImageModalWithNavigation(images, currentIndex, questionId, questionNumber) {
            const modal = document.getElementById('fullScreenModal');
            const modalImage = document.getElementById('fullScreenImage');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Set current images and index for navigation
            currentImages = images.map(img => img.image || img);
            currentImageIndex = currentIndex;
            
            // Update modal content
            modalImage.src = currentImages[currentImageIndex];
            modalTitle.textContent = `Request #${questionNumber} - Output Images`;
            imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            
            // Show/hide navigation buttons based on position
            if (currentImages.length > 1) {
                // Show previous button only if not at first image
                prevBtn.style.display = currentImageIndex > 0 ? 'flex' : 'none';
                // Show next button only if not at last image
                nextBtn.style.display = currentImageIndex < currentImages.length - 1 ? 'flex' : 'none';
            } else {
                // Hide both buttons if only one image
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }
            
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === currentImages.length - 1;
            
            modal.style.display = 'block';
        }

        // Function to navigate between images
        function navigateImage(newIndex, questionId, questionNumber) {
            if (newIndex >= 0 && newIndex < currentImages.length) {
                currentImageIndex = newIndex;
                updateModalImage();
            }
        }

        // Function to close image modal
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            
            // Reset modal content to original state
            modal.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <img id="modalImage" src="" alt="Enlarged Image" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">
                    <button onclick="closeImageModal()" style="position: absolute; top: 20px; right: 30px; color: white; font-size: 28px; font-weight: bold; background: none; border: none; cursor: pointer;">&times;</button>
                </div>
            `;
            
            // Clear stored data
            delete modal.dataset.currentIndex;
            delete modal.dataset.questionId;
            delete modal.dataset.images;
        }

        function evaluateImages(questionId, questionNumber) {
            console.log(`Starting evaluation for Request #${questionNumber}`);
            // Redirect to evaluate.html with question data
            const question = questions.find(q => q._id === questionId);
            if (question) {
                // Store question data in sessionStorage for evaluate.html to use
                sessionStorage.setItem('evaluateQuestion', JSON.stringify({
                    id: questionId,
                    number: questionNumber,
                    prompt: question.prompt,
                    imageInput: question.imageInput,
                    outputs: question.outputs
                }));
                
                // Redirect to evaluate.html
                window.location.href = './evaluate.html';
            } else {
                alert('Question not found');
            }
        }

        // // Function to load filter data (users and questions)
        // async function loadFilterData() {
        //     try {
        //         // Load users list
        //         const usersResponse = await fetch('https://surveyform-kxkk.onrender.com/users-list');
        //         if (usersResponse.ok) {
        //             const usersData = await usersResponse.json();
        //             populateUserFilter(usersData.users);
        //         }
                
        //         // Load questions list
        //         const questionsResponse = await fetch('https://surveyform-kxkk.onrender.com/questions-list');
        //         if (questionsResponse.ok) {
        //             const questionsData = await questionsResponse.json();
        //             populateQuestionFilter(questionsData.questions);
        //         }
        //     } catch (error) {
        //         console.error('Error loading filter data:', error);
        //     }
        // }

        // Function to populate user filter
        // function populateUserFilter(users) {
        //     const userFilter = document.getElementById('userFilter');
        //     userFilter.innerHTML = '<option value="all">All Users</option>';
            
        //     users.forEach(user => {
        //         const option = document.createElement('option');
        //         option.value = user._id;
        //         option.textContent = `${user.name} (@${user.username})`;
        //         userFilter.appendChild(option);
        //     });
        // }

        // // Function to populate question filter
        // function populateQuestionFilter(questions) {
        //     const questionFilter = document.getElementById('questionFilter');
        //     questionFilter.innerHTML = '<option value="all">All Requests</option>';
            
        //     // Questions đã được sắp xếp theo stt_doc từ server
        //     questions.forEach((question, index) => {
        //         const option = document.createElement('option');
        //         option.value = question._id;
        //         // Use stt_doc as question number, fallback to index + 1
        //         const questionNumber = question.stt_doc || (index + 1);
        //         option.textContent = `Request #${questionNumber}`;
        //         questionFilter.appendChild(option);
        //     });
        // }

        // // Function to load all responses
        // async function loadAllResponses(page = 1) {
        //     try {
        //         const params = new URLSearchParams({
        //             page: page,
        //             limit: 10,
        //             userId: currentFilters.userId,
        //             questionId: currentFilters.questionId
        //         });
                
        //         const response = await fetch(`https://surveyform-kxkk.onrender.com/all-responses?${params}`);
        //         if (!response.ok) {
        //             throw new Error(`HTTP error! status: ${response.status}`);
        //         }
        //         const data = await response.json();
                
        //         currentPage = data.pagination.currentPage;
        //         totalPages = data.pagination.totalPages;
        //         maxOutputs = data.maxOutputs || 0;
                
        //         renderResponsesTableHeader();
        //         renderResponsesTable(data.responses);
        //         renderPagination(data.pagination);
        //         updateResponsesStats(data.pagination.totalResponses);
                
        //     } catch (error) {
        //         console.error('Error loading responses:', error);
        //         showResponsesError('Failed to load responses. Please try again later.');
        //     }
        // }

        // Function to render responses table header
        // function renderResponsesTableHeader() {
        //     const thead = document.getElementById('responsesTableHead');
        //     const tr = thead.querySelector('tr');
            
        //     // Clear existing output columns
        //     const existingOutputs = tr.querySelectorAll('th[data-output]');
        //     existingOutputs.forEach(th => th.remove());
            
        //     // Add output columns theo thứ tự từ 1 đến maxOutputs
        //     // Sử dụng insertBefore với thứ tự ngược lại để đảm bảo Output 1, 2, 3, 4
        //     for (let i = maxOutputs; i >= 1; i--) {
        //         const th = document.createElement('th');
        //         th.textContent = `Output ${i}`;
        //         th.setAttribute('data-output', i);
                
        //         // Insert before Comments column (4th position: User, Question#, Prompt, Comments, Date, Actions)
        //         const commentsTh = tr.children[3]; // Comments is at index 3
        //         tr.insertBefore(th, commentsTh);
        //     }
        // }

        // Function to render responses table
        // function renderResponsesTable(responses) {
        //     const tbody = document.getElementById('responsesTableBody');
            
        //     console.log('Rendering responses with maxOutputs:', maxOutputs);
        //     console.log('Sample response ratings:', responses[0]?.ratings);
            
        //     if (responses.length === 0) {
        //         const totalCols = 6 + maxOutputs; // User, Question#, Prompt, Outputs, Comments, Date, Actions
        //         tbody.innerHTML = `
        //             <tr>
        //                 <td colspan="${totalCols}" style="text-align: center; padding: 40px; color: #6b7280;">
        //                     No responses found
        //                 </td>
        //             </tr>
        //         `;
        //         return;
        //     }
            
        //     tbody.innerHTML = responses.map(response => {
        //         const ratings = response.ratings || {};
                
        //         // Tạo HTML cho từng output theo thứ tự từ 1 đến maxOutputs
        //         const outputColumns = [];
        //         for (let i = 1; i <= maxOutputs; i++) {
        //             const ratingKey = `image${i}`;
        //             const rating = ratings[ratingKey];
                    
        //             if (rating) {
        //                 const outputHtml = `
        //                     <div class="output-rating">
        //                         <div class="rating-item">
        //                             <span class="rating-label">Overall:</span>
        //                             <span class="rating-value">${rating.overall || 'N/A'}</span>
        //                         </div>
        //                         <div class="rating-item">
        //                             <span class="rating-label">Accuracy:</span>
        //                             <span class="rating-value">${rating.accuracy || 'N/A'}</span>
        //                         </div>
        //                         <div class="rating-item">
        //                             <span class="rating-label">Naturalness:</span>
        //                             <span class="rating-value">${rating.naturalness || 'N/A'}</span>
        //                         </div>
        //                         <div class="rating-item">
        //                             <span class="rating-label">Sharpness:</span>
        //                             <span class="rating-value">${rating.sharpness || 'N/A'}</span>
        //                         </div>
        //                         <div class="rating-item">
        //                             <span class="rating-label">Ranking:</span>
        //                             <span class="rating-value">${rating.ranking || 'N/A'}</span>
        //                         </div>
        //                     </div>
        //                 `;
        //                 outputColumns.push(outputHtml);
        //             } else {
        //                 outputColumns.push('<span style="color: #6b7280;">No data</span>');
        //             }
        //         }
                
        //         const date = new Date(response.createdAt).toLocaleDateString('en-US', {
        //             year: 'numeric',
        //             month: 'short',
        //             day: 'numeric',
        //             hour: '2-digit',
        //             minute: '2-digit'
        //         });
                
        //         // Tạo output columns HTML theo thứ tự từ 1 đến maxOutputs
        //         const outputColumnsHtml = outputColumns.map(html => `<td>${html}</td>`).join('');
                
        //         return `
        //             <tr>
        //                 <td>
        //                     <div class="user-info">
        //                         <div class="user-name">${response.userName || 'Unknown'}</div>
        //                         <div class="user-username">@${response.userUsername || 'unknown'}</div>
        //                     </div>
        //                 </td>
        //                 <td>Request #${response.questionNumber}</td>
        //                 <td>
        //                     <div class="question-prompt" title="${response.questionPrompt || 'No prompt'}">
        //                         ${response.questionPrompt || 'No prompt'}
        //                     </div>
        //                 </td>
        //                 ${outputColumnsHtml}
        //                 <td>
        //                     <div class="comments-cell" title="${response.comments || 'No comments'}">
        //                         ${response.comments || 'No comments'}
        //                     </div>
        //                 </td>
        //                 <td class="date-cell">${date}</td>
        //                 <td>
        //                     <button class="delete-btn" onclick="deleteResponse('${response._id}')" title="Delete response">
        //                         Delete
        //                     </button>
        //                 </td>
        //             </tr>
        //         `;
        //     }).join('');
        // }

        // Function to render pagination
        function renderPagination(pagination) {
            const paginationContainer = document.getElementById('pagination');
            
            if (pagination.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `
                <button class="pagination-btn" onclick="loadAllResponses(${pagination.currentPage - 1})" 
                        ${!pagination.hasPrevPage ? 'disabled' : ''}>
                    Previous
                </button>
            `;
            
            // Page numbers
            const startPage = Math.max(1, pagination.currentPage - 2);
            const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button class="pagination-btn ${i === pagination.currentPage ? 'active' : ''}" 
                            onclick="loadAllResponses(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // Next button
            paginationHtml += `
                <button class="pagination-btn" onclick="loadAllResponses(${pagination.currentPage + 1})" 
                        ${!pagination.hasNextPage ? 'disabled' : ''}>
                    Next
                </button>
            `;
            
            // Page info
            paginationHtml += `
                <div class="pagination-info">
                    Page ${pagination.currentPage} of ${pagination.totalPages}
                </div>
            `;
            
            paginationContainer.innerHTML = paginationHtml;
        }

        // Function to update responses stats
        function updateResponsesStats(totalResponses) {
            const statsElement = document.getElementById('totalResponses');
            statsElement.textContent = totalResponses;
        }

        // Function to show responses error
        function showResponsesError(message) {
            const tbody = document.getElementById('responsesTableBody');
            const totalCols = 6 + maxOutputs; // User, Question#, Prompt, Outputs, Comments, Date, Actions
            tbody.innerHTML = `
                <tr>
                    <td colspan="${totalCols}" style="text-align: center; padding: 40px; color: #ef4444;">
                        <div style="margin-bottom: 16px;">
                            <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 32px; height: 32px;">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1 9a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd"/>
                    </svg>
                        </div>
                        <div>${message}</div>
                        <button onclick="loadAllResponses()" style="margin-top: 16px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Retry
                        </button>
                    </td>
                </tr>
            `;
        }







        // Function to load all questions
        async function loadAllQuestions() {
            try {
                const response = await fetch('https://surveyform-kxkk.onrender.com/all-questions');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Store questions data globally for image modal
                window.allQuestionsData = data.questions;
                
                renderQuestionsTable(data.questions);
                
            } catch (error) {
                console.error('Error loading questions:', error);
                showQuestionsError('Failed to load questions. Please try again later.');
            }
        }

        // Function to render questions table
        function renderQuestionsTable(questions) {
            const tbody = document.getElementById('questionsTableBody');
            
            if (questions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #6b7280;">
                            No questions found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = questions.map((question, index) => {
                // Use stt_doc as question number, fallback to index + 1
                const questionNumber = question.stt_doc || (index + 1);
                const status = question.isDelete ? 'Deleted' : 'Active';
                const statusClass = question.isDelete ? 'status-deleted' : 'status-active';
                
                // Render output images
                const outputImagesHtml = question.outputs ? question.outputs.map((output, outputIndex) => {
                    const imageUrl = typeof output === 'object' ? output.image : output;
                    return `<img src="${imageUrl}" alt="Output" class="output-image" onerror="this.style.display='none'" onclick="showImageModal('${imageUrl}', 'output', ${index}, ${outputIndex})">`;
                }).join('') : '';
                
                return `
                    <tr>
                        <td>Request #${questionNumber}</td>
                        <td class="question-prompt-cell">${question.prompt}</td>
                        <td>
                            <img src="${question.imageInput}" alt="Input" class="question-image" onerror="this.style.display='none'" onclick="showImageModal('${question.imageInput}', 'input', ${index})">
                        </td>
                        <td>
                            <div class="output-images-grid">
                                ${outputImagesHtml}
        </div>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${status}</span>
                        </td>
                        <td>
                            ${!question.isDelete ? `<button class="delete-btn" onclick="deleteQuestion('${question._id}')" title="Delete question">Delete</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Function to show questions error
        function showQuestionsError(message) {
            const tbody = document.getElementById('questionsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">
                        ${message}
                    </td>
                </tr>
            `;
        }

        // Function to delete question
        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }
            
            try {
                const response = await fetch('https://surveyform-kxkk.onrender.com/delete-question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ questionId })
                });
                
                if (response.ok) {
                    alert('Question deleted successfully!');
                    loadAllQuestions(); // Reload questions table
                } else {
                    const error = await response.json();
                    alert('Error deleting question: ' + error.message);
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                alert('Failed to delete question. Please try again.');
            }
        }

        // Function to add output image input
        function addOutputImageInput() {
            const container = document.getElementById('outputImagesContainer');
            const newInput = document.createElement('div');
            newInput.className = 'output-image-input';
            newInput.innerHTML = `
                <div class="output-input-row">
                    <input type="url" name="outputUrls[]" required placeholder="https://example.com/output.jpg">
                    <input type="text" name="outputSrcs[]" required placeholder="Source (e.g., Pinterest, DALL-E)">
                </div>
                <button type="button" class="remove-output-btn" onclick="removeOutputImage(this)">Remove</button>
            `;
            container.appendChild(newInput);
        }

        // Function to remove output image input
        function removeOutputImage(button) {
            const container = document.getElementById('outputImagesContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                alert('You must have at least one output image.');
            }
        }

        // Global variables for image modal
        let currentImages = [];
        let currentImageIndex = 0;
        let currentQuestionIndex = -1;
        let currentQuestion = null;
        let currentQuestionNumber = 0;

        // Function to show image modal with all images (input + outputs)
        function showImageModal(questionIndex) {
            console.log('showImageModal called with questionIndex:', questionIndex);
            
            // Find the question in current page
            const question = questions[questionIndex];
            if (!question) {
                console.error('Question not found at index:', questionIndex);
                return;
            }
            
            console.log('Found question:', question);
            
            // Use stt_doc as question number, fallback to pagination calculation
            const actualQuestionNumber = question.stt_doc || ((currentPage - 1) * itemsPerPage + questionIndex + 1);
            console.log('Actual question number:', actualQuestionNumber);
            
            // Show preview modal with input image on left and output grid on right
            showPreviewModalMain(question, actualQuestionNumber);
        }

        // Function to show preview modal with input on left and output grid on right
        function showPreviewModal(questionIndex) {
            console.log('🔍 DEBUG showPreviewModal called with questionIndex:', questionIndex);
            console.log('🔍 DEBUG questions array:', questions);
            console.log('🔍 DEBUG questions length:', questions ? questions.length : 'undefined');
            
            // Find the question in current page
            const question = questions[questionIndex];
            console.log('🔍 DEBUG found question at index', questionIndex, ':', question);
            
            if (!question) {
                console.error('❌ Question not found at index:', questionIndex);
                alert('Question data not found. Please refresh the page.');
                return;
            }
            
            console.log('🔍 DEBUG question.imageInput:', question.imageInput);
            console.log('🔍 DEBUG question.outputs:', question.outputs);
            console.log('🔍 DEBUG question.outputs length:', question.outputs ? question.outputs.length : 'undefined');
            
            // Use stt_doc as question number, fallback to pagination calculation
            const actualQuestionNumber = question.stt_doc || ((currentPage - 1) * itemsPerPage + questionIndex + 1);
            console.log('🔍 DEBUG actual question number:', actualQuestionNumber);
            
            // Call the main showPreviewModal function with both parameters
            showPreviewModalMain(question, actualQuestionNumber);
        }
        function preparePreviewAllImagesArray(question) {
            previewAllImages = [];
            
            // Add input image
            if (question.imageInput) {
                previewAllImages.push({
                    type: 'input',
                    index: 0,
                    url: question.imageInput,
                    title: 'Input Image'
                });
            }
            
            // Add output images
            if (question.outputs && question.outputs.length > 0) {
                question.outputs.forEach((output, index) => {
                    let imageUrl = '';
                    if (typeof output === 'string') {
                        imageUrl = output;
                    } else if (output.image) {
                        imageUrl = output.image;
                    } else if (output.url) {
                        imageUrl = output.url;
                    }
                    
                    if (imageUrl) {
                        previewAllImages.push({
                            type: 'output',
                            index: index,
                            url: imageUrl,
                            title: `Output Image ${index + 1}`
                        });
                    }
                });
            }
            
            console.log('Preview all images prepared:', previewAllImages);
        }


        // Function to create preview content with navigation
        function createPreviewContentWithNavigation(question, questionNumber) {
            const inputImage = question.imageInput || '';
            const outputs = question.outputs || [];
            
            // Process output images - handle different output structures
            const outputImages = outputs.map((output, index) => {
                let imageUrl = '';
                let outputType = 'output';
                
                if (typeof output === 'string') {
                    imageUrl = output;
                } else if (typeof output === 'object' && output) {
                    // Handle different object structures
                    imageUrl = output.url || output.image || '';
                    outputType = output.type || 'output';
                }
                
                return {
                    url: imageUrl,
                    title: `Output ${index + 1}`,
                    type: outputType
                };
            }).filter(img => img.url && img.url.trim() !== '');
            
            // Collect all images for navigation
            const allImages = [];
            
            // Add input image
            if (inputImage && inputImage.trim() !== '') {
                allImages.push({
                    url: inputImage,
                    title: 'Input Image',
                    type: 'input'
                });
            }
            
            // Add output images
            allImages.push(...outputImages);
            
            // Set current images for navigation
            currentImages = allImages;
            // Don't reset currentImageIndex, use existing value
            if (currentImageIndex < 0 || currentImageIndex >= allImages.length) {
                currentImageIndex = 0;
            }
            currentQuestionIndex = -1; // Not needed for preview
            
            // Get current image based on currentImageIndex
            const currentImage = allImages[currentImageIndex] || allImages[0];
            
            // Determine which image to highlight
            const isInputImage = currentImage && currentImage.type === 'input';
            const isOutputImage = currentImage && currentImage.type === 'output';
            
            return `
                <button class="fullscreen-nav-btn prev-btn" id="fullScreenPrevBtn">&lt;</button>
                <div class="preview-container">
                    <div class="preview-left">
                        <div class="input-image-section">
                            <h3 class="section-title">Input Image</h3>
                            <div class="input-image-container">
                                ${inputImage ? 
                                    `<img src="${inputImage}" alt="Input Image" class="preview-input-image ${isInputImage ? 'highlighted' : ''}" onclick="showFullImage('${inputImage}', 'Input Image')">` :
                                    '<div class="no-image-placeholder">No input image</div>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-right">
                        <div class="output-images-section">
                            <h3 class="section-title">Output Images (${outputImages.length})</h3>
                            <div class="output-grid">
                                ${outputImages.map((img, index) => `
                                    <div class="output-item ${isOutputImage && img.url === currentImage.url ? 'highlighted' : ''}" onclick="showFullImage('${img.url}', '${img.title}')">
                                        <img src="${img.url}" alt="${img.title}" class="preview-output-image">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
            `;
        }


        function showPreviewGallery(questionNumber) {
    const modal = document.getElementById('previewModal');
    const previewInputImage = document.getElementById('previewInputImage');
    const previewOutputsGrid = document.getElementById('previewOutputsGrid');
    
    // Set input image
    if (previewCurrentQuestion.imageInput) {
        previewInputImage.src = previewCurrentQuestion.imageInput;
        previewInputImage.alt = 'Input Image';
    }
    
    // Clear and populate output images grid
    previewOutputsGrid.innerHTML = '';
    
    if (previewCurrentQuestion.outputs && previewCurrentQuestion.outputs.length > 0) {
        previewCurrentQuestion.outputs.forEach((output, i) => {
            let imageUrl = '';
            if (typeof output === 'string') {
                imageUrl = output;
            } else if (output.image) {
                imageUrl = output.image;
            } else if (output.url) {
                imageUrl = output.url;
            }
            
            if (imageUrl) {
                const outputItem = document.createElement('div');
                outputItem.classList.add('preview-output-item');
                
                outputItem.innerHTML = `
                    <img class="preview-output-image" src="${imageUrl}" alt="Output Image ${i+1}" 
                         onclick="showPreviewFullImage('${imageUrl}', 'Output Image ${i+1}')">
                    <div class="preview-output-label">Output ${i+1}</div>
                `;
                
                previewOutputsGrid.appendChild(outputItem);
            }
        });
    } else {
        previewOutputsGrid.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">No output images available</div>';
    }
    
    // Set current image index to 0 (input image)
    previewCurrentImageIndex = 0;
    
    // Show modal
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Update navigation buttons
    updatePreviewNavigationButtons();
}

// Navigate through images in preview
function navigatePreviewImage(direction) {
    previewCurrentImageIndex += direction;
    
    // Handle bounds with infinite loop
    if (previewCurrentImageIndex < 0) {
        previewCurrentImageIndex = previewAllImages.length - 1;
    } else if (previewCurrentImageIndex >= previewAllImages.length) {
        previewCurrentImageIndex = 0;
    }
    
    const image = previewAllImages[previewCurrentImageIndex];
    
    if (image.type === 'input') {
        // Show input image in preview
        showPreviewImage('input', 0);
    } else {
        // Show output image in preview
        showPreviewImage('output', image.index);
    }
}

// Show specific image in preview
function showPreviewImage(type, index) {
    const previewInputImage = document.getElementById('previewInputImage');
    const previewOutputItems = document.querySelectorAll('.preview-output-item');
    
    // Remove active class from all items
    previewOutputItems.forEach(item => {
        item.classList.remove('active');
    });
    
    if (type === 'input') {
        // Highlight input image (we can't add class to input image container easily)
        // Instead, we'll scroll to top and ensure input image is visible
        const previewLeftPanel = document.querySelector('.preview-left-panel');
        if (previewLeftPanel) {
            previewLeftPanel.scrollTop = 0;
        }
    } else {
        // Highlight the clicked output image
        if (previewOutputItems[index]) {
            previewOutputItems[index].classList.add('active');
            // Scroll to make the active item visible
            previewOutputItems[index].scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest',
                inline: 'nearest'
            });
        }
    }
    
    // Update navigation buttons
    updatePreviewNavigationButtons();
}

// Update navigation buttons state
function updatePreviewNavigationButtons() {
    const prevButton = document.querySelector('.preview-nav.prev');
    const nextButton = document.querySelector('.preview-nav.next');
    
    // Always enable both buttons since we're cycling through all images
    if (prevButton) prevButton.disabled = false;
    if (nextButton) nextButton.disabled = false;
}

// Show full image from preview
function showPreviewFullImage(imageUrl, title) {
    const fullImageModal = document.getElementById('previewFullImageModal');
    const fullImage = document.getElementById('previewFullImage');
    
    fullImage.src = imageUrl;
    fullImage.alt = title;
    fullImageModal.style.display = 'flex';
}

// Close preview full image modal
function closePreviewFullImage() {
    const fullImageModal = document.getElementById('previewFullImageModal');
    fullImageModal.style.display = 'none';
}

// Close preview modal
function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside the content
document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePreviewModal();
    }
});

// Close full image modal when clicking outside the image
document.getElementById('previewFullImageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePreviewFullImage();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePreviewModal();
        closePreviewFullImage();
    }
});

// Replace the existing showImageModal function to use new preview modal
function showImageModal(questionIndex) {
    showPreviewModal(questionIndex);
}

// Cập nhật hàm evaluateImages để sử dụng preview modal
function evaluateImages(questionId, questionNumber) {
    console.log(`Starting evaluation for Request #${questionNumber}`);
    // Redirect to evaluate.html with question data
    const question = questions.find(q => q._id === questionId);
    if (question) {
        // Store question data in sessionStorage for evaluate.html to use
        sessionStorage.setItem('evaluateQuestion', JSON.stringify({
            id: questionId,
            number: questionNumber,
            prompt: question.prompt,
            imageInput: question.imageInput,
            outputs: question.outputs
        }));
        
        // Redirect to evaluate.html
        window.location.href = './evaluate.html';
    } else {
        alert('Question not found');
    }
        }

        // Function to create preview content (original)
        function createPreviewContent(question, questionNumber) {
            const inputImage = question.imageInput || '';
            const outputs = question.outputs || [];
            
            // Process output images - handle different output structures
            const outputImages = outputs.map((output, index) => {
                let imageUrl = '';
                let outputType = 'output';
                
                if (typeof output === 'string') {
                    imageUrl = output;
                } else if (typeof output === 'object' && output) {
                    // Handle different object structures
                    imageUrl = output.url || output.image || '';
                    outputType = output.type || 'output';
                }
                
                return {
                    url: imageUrl,
                    title: `Output ${index + 1}`,
                    type: outputType
                };
            }).filter(img => img.url && img.url.trim() !== '');
            
            return `
                <div class="preview-container">
                    <div class="preview-left">
                        <div class="input-image-section">
                            <h3 class="section-title">Input Image</h3>
                            <div class="input-image-container">
                                ${inputImage ? 
                                    `<img src="${inputImage}" alt="Input Image" class="preview-input-image" onclick="showFullImage('${inputImage}', 'Input Image')">` :
                                    '<div class="no-image-placeholder">No input image</div>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-right">
                        <div class="output-images-section">
                            <h3 class="section-title">Output Images (${outputImages.length})</h3>
                            <div class="output-grid">
                                ${outputImages.map((img, index) => `
                                    <div class="output-item" onclick="showFullImage('${img.url}', '${img.title}')">
                                        <img src="${img.url}" alt="${img.title}" class="preview-output-image">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to show full image in modal
        function showFullImage(imageUrl, title) {
            // Find the question that contains this image
            const question = questions.find(q => {
                // Check if it's the input image
                if (q.imageInput === imageUrl) return true;
                
                // Check if it's one of the output images
                if (q.outputs && q.outputs.some(output => {
                    const outputUrl = typeof output === 'object' ? (output.url || output.image) : output;
                    return outputUrl === imageUrl;
                })) return true;
                
                return false;
            });
            
            if (!question) {
                // Fallback to single image view
                showSingleImage(imageUrl, title);
                return;
            }
            
            // Get question number
            const questionNumber = question.stt_doc || questions.indexOf(question) + 1;
            
            // Collect all images (input + outputs)
            const allImages = [];
            
            // Add input image
            if (question.imageInput && question.imageInput.trim() !== '') {
                allImages.push({
                    url: question.imageInput,
                    title: 'Input Image',
                    type: 'input'
                });
            }
            
            // Add output images
            if (question.outputs && question.outputs.length > 0) {
                question.outputs.forEach((output, index) => {
                    const outputUrl = typeof output === 'object' ? (output.url || output.image) : output;
                    if (outputUrl && outputUrl.trim() !== '') {
                        allImages.push({
                            url: outputUrl,
                            title: `Output ${index + 1}`,
                            type: 'output'
                        });
                    }
                });
            }
            
            // Find current image index
            const currentIndex = allImages.findIndex(img => img.url === imageUrl);
            
            if (currentIndex !== -1) {
                // Show all images with navigation
                showAllImagesWithNavigation(allImages, currentIndex, questionNumber);
            } else {
                // Fallback to single image view
                showSingleImage(imageUrl, title);
            }
        }

        // Function to show single image (fallback)
        function showSingleImage(imageUrl, title) {
            const modal = document.getElementById('fullScreenModal');
            const modalBody = document.querySelector('.fullscreen-body');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            
            // Reset modal body to original state
            modalBody.innerHTML = `
                <button class="fullscreen-nav-btn prev-btn" id="fullScreenPrevBtn">&lt;</button>
                <div class="fullscreen-image-container">
                    <img id="fullScreenImage" src="${imageUrl}" alt="Full Screen Image">
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
            `;
            
            // Get the newly created elements
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Set current images and index
            currentImages = [imageUrl];
            currentImageIndex = 0;
            
            // Update modal content
            modalTitle.textContent = title;
            if (imageCounter) imageCounter.textContent = '1 / 1';
            
            // Hide navigation buttons for single image
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
            if (imageCounter) imageCounter.style.display = 'block';
            
            modal.style.display = 'block';
        }

        // Function to show all images with navigation
        function showAllImagesWithNavigation(allImages, startIndex, questionNumber) {
            const modal = document.getElementById('fullScreenModal');
            const modalBody = document.querySelector('.fullscreen-body');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            
            // Reset modal body to original state
            modalBody.innerHTML = `
                <button class="fullscreen-nav-btn prev-btn" id="fullScreenPrevBtn">&lt;</button>
                <div class="fullscreen-image-container">
                    <img id="fullScreenImage" src="" alt="Full Screen Image">
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
            `;
            
            const modalImage = document.getElementById('fullScreenImage');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Set current images and index
            currentImages = allImages;
            currentImageIndex = startIndex;
            currentQuestionIndex = -1; // Not needed for this view
            
            // Update modal content
            const currentImage = currentImages[currentImageIndex];
            modalImage.src = currentImage.url;
            modalTitle.textContent = `Request #${questionNumber} - ${currentImage.title}`;
            if (imageCounter) imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            
            // Show navigation buttons
            if (prevBtn) prevBtn.style.display = 'flex';
            if (nextBtn) nextBtn.style.display = 'flex';
            if (imageCounter) imageCounter.style.display = 'block';
            
            // Enable/disable navigation buttons
            if (prevBtn) prevBtn.disabled = false;
            if (nextBtn) nextBtn.disabled = false;
            
            modal.style.display = 'block';
        }

        // Function to show all question images in modal
        function showAllQuestionImages(questionIndex, startIndex = 0, actualQuestionNumber, allImages) {
            console.log('showAllQuestionImages called:', { questionIndex, startIndex, actualQuestionNumber, allImages });
            
            const modal = document.getElementById('fullScreenModal');
            const modalBody = document.querySelector('.fullscreen-body');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            
            // Reset modal body to original state
            modalBody.innerHTML = `
                <button class="fullscreen-nav-btn prev-btn" id="fullScreenPrevBtn">&lt;</button>
                <div class="fullscreen-image-container">
                    <img id="fullScreenImage" src="" alt="Full Screen Image">
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
            `;
            
            const modalImage = document.getElementById('fullScreenImage');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Set current images and index
            currentImages = allImages;
            currentImageIndex = startIndex;
            currentQuestionIndex = questionIndex; // Store for title calculation
            
            console.log('Current images set:', currentImages);
            console.log('Current image index:', currentImageIndex);
            console.log('Current question index:', currentQuestionIndex);
            
            // Update modal content
            const currentImage = currentImages[currentImageIndex];
            console.log('Current image:', currentImage);
            
            modalImage.src = currentImage.url;
            modalTitle.textContent = `Request #${actualQuestionNumber} - ${currentImage.title || currentImage.type || 'Image'}`;
            if (imageCounter) imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            
            // Show/hide navigation buttons (always show if more than 1 image)
            if (prevBtn) prevBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
            if (nextBtn) nextBtn.style.display = currentImages.length > 1 ? 'flex' : 'none';
            
            // Never disable buttons for infinite loop
            if (prevBtn) prevBtn.disabled = false;
            if (nextBtn) nextBtn.disabled = false;
            
            modal.style.display = 'block';
        }

        // Function to navigate to previous image (with infinite loop)
        function showPreviousImage() {
            console.log('showPreviousImage called - currentImageIndex:', currentImageIndex);
            
            // Check if we're at the first image in single view
            if (currentImageIndex === 0) {
                // Check if preview container doesn't exist (meaning we're in single view)
                const previewContainer = document.querySelector('.preview-container');
                if (!previewContainer) {
                    // We're at the first image (Input) in single view, switch back to preview
                    console.log('Switching from single image view back to preview');
                    switchToPreviewView();
                    return;
                }
            }
            
            // Regular navigation
            if (currentImageIndex > 0) {
                currentImageIndex--;
            } else {
                // Loop to last image
                currentImageIndex = currentImages.length - 1;
            }
            
            console.log('showPreviousImage - new currentImageIndex:', currentImageIndex);
            updateModalImage();
        }

        // Function to navigate to next image (with infinite loop)
        function showNextImage() {
            console.log('showNextImage called - currentImageIndex:', currentImageIndex, 'max:', currentImages.length - 1);
            
            // Check if we're in preview mode (check if preview container exists)
            const previewContainer = document.querySelector('.preview-container');
            if (previewContainer) {
                // We're in preview mode, switch to single image view (Input first)
                console.log('Switching from preview to single image view (Input)');
                switchToSingleImageView(0); // Start with Input image (index 0)
                return;
            }
            
            // Regular single image navigation
            if (currentImageIndex < currentImages.length - 1) {
                currentImageIndex++;
            } else {
                // At last image, switch back to preview mode
                console.log('At last image, switching back to preview mode');
                switchToPreviewView();
                return;
            }
            
            console.log('showNextImage - new currentImageIndex:', currentImageIndex);
            updateModalImage();
        }

        // Function to switch from preview to single image view
        function switchToSingleImageView(startIndex = 0) {
            const modal = document.getElementById('fullScreenModal');
            const modalBody = document.querySelector('.fullscreen-body');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            
            // Reset modal body to single image view
            modalBody.innerHTML = `
                <button class="fullscreen-nav-btn prev-btn" id="fullScreenPrevBtn">&lt;</button>
                <div class="fullscreen-image-container">
                    <img id="fullScreenImage" src="" alt="Full Screen Image">
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
            `;
            
            // Set current image index
            currentImageIndex = startIndex;
            
            // Get the newly created elements
            const modalImage = document.getElementById('fullScreenImage');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Update modal content
            const currentImage = currentImages[currentImageIndex];
            if (currentImage) {
                modalImage.src = currentImage.url;
                modalTitle.textContent = `Request #${currentQuestionNumber} - ${currentImage.title}`;
                if (imageCounter) imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            }
            
            // Show navigation buttons
            if (prevBtn) prevBtn.style.display = 'flex';
            if (nextBtn) nextBtn.style.display = 'flex';
            if (imageCounter) imageCounter.style.display = 'block';
            
            // Enable navigation buttons
            if (prevBtn) prevBtn.disabled = false;
            if (nextBtn) nextBtn.disabled = false;
            
            // Add event listeners for the new buttons
            setTimeout(() => {
                const newPrevBtn = document.getElementById('fullScreenPrevBtn');
                const newNextBtn = document.getElementById('fullScreenNextBtn');
                
                if (newPrevBtn) {
                    newPrevBtn.onclick = showPreviousImage;
                }
                if (newNextBtn) {
                    newNextBtn.onclick = showNextImage;
                }
            }, 0);
        }

        // Function to switch from single image view back to preview
        function switchToPreviewView() {
            const modal = document.getElementById('fullScreenModal');
            const modalBody = document.querySelector('.fullscreen-body');
            const modalTitle = document.getElementById('fullScreenTitle');
            
            // Create preview content with navigation
            const previewContent = createPreviewContentWithNavigation(currentQuestion, currentQuestionNumber);
            
            // Replace modal body with preview content
            modalBody.innerHTML = previewContent;
            
            // Update modal title
            modalTitle.textContent = `Request #${currentQuestionNumber} - Preview`;
            
            // Hide the image counter for preview mode
            const imageCounter = document.getElementById('fullScreenCounter');
            if (imageCounter) imageCounter.style.display = 'none';
            
            // Add event listeners for the new navigation buttons
            setTimeout(() => {
                const newPrevBtn = document.getElementById('fullScreenPrevBtn');
                const newNextBtn = document.getElementById('fullScreenNextBtn');
                
                if (newPrevBtn) {
                    newPrevBtn.onclick = showPreviousImage;
                }
                if (newNextBtn) {
                    newNextBtn.onclick = showNextImage;
                }
                
                // Add click handlers for images in preview
                addPreviewImageClickHandlers();
            }, 0);
        }

        // Function to add click handlers for images in preview
        function addPreviewImageClickHandlers() {
            // Input image click handler
            const inputImage = document.querySelector('.preview-input-image');
            if (inputImage) {
                inputImage.onclick = function() {
                    // Find input image index
                    const inputIndex = currentImages.findIndex(img => img.type === 'input');
                    if (inputIndex !== -1) {
                        switchToSingleImageView(inputIndex);
                    }
                };
            }
            
            // Output images click handlers
            const outputItems = document.querySelectorAll('.output-item');
            outputItems.forEach((item, index) => {
                item.onclick = function() {
                    // Find corresponding output image index
                    const outputIndex = currentImages.findIndex((img, idx) => 
                        img.type === 'output' && 
                        currentImages.filter((img, i) => i <= idx && img.type === 'output').length === index + 1
                    );
                    if (outputIndex !== -1) {
                        switchToSingleImageView(outputIndex);
                    }
                };
            });
        }

        // Function to show preview modal with input on left and output grid on right
        function showPreviewModalMain(question, questionNumber) {
            console.log('showPreviewModal called:', { question, questionNumber });
            
            const modal = document.getElementById('fullScreenModal');
            const modalTitle = document.getElementById('fullScreenTitle');
            const modalBody = document.querySelector('.fullscreen-body');
            
            // Set current question và number
            currentQuestion = question;
            currentQuestionNumber = questionNumber;
            
            // Process images for navigation
            const inputImage = question.imageInput || '';
            const outputs = question.outputs || [];
            
            // Collect all images for navigation
            currentImages = [];
            
            // Add input image
            if (inputImage && inputImage.trim() !== '') {
                currentImages.push({
                    url: inputImage,
                    title: 'Input Image',
                    type: 'input'
                });
            }
            
            // Add output images
            outputs.forEach((output, index) => {
                let imageUrl = '';
                
                if (typeof output === 'string') {
                    imageUrl = output;
                } else if (output.image) {
                    imageUrl = output.image;
                } else if (output.url) {
                    imageUrl = output.url;
                }
                
                if (imageUrl && imageUrl.trim() !== '') {
                    currentImages.push({
                        url: imageUrl,
                        title: `Output ${index + 1}`,
                        type: 'output'
                    });
                }
            });
            
            currentImageIndex = 0;
            
            // Update modal title
            modalTitle.textContent = `Request #${questionNumber} - Preview`;
            
            // Create preview content
            const previewContent = createPreviewContentWithNavigation(question, questionNumber);
            
            // Replace modal body with preview content
            modalBody.innerHTML = previewContent;
            
            // Hide the image counter for preview mode
            const imageCounter = document.getElementById('fullScreenCounter');
            if (imageCounter) imageCounter.style.display = 'none';
            
            // Show navigation buttons but keep them functional
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            if (prevBtn) prevBtn.style.display = 'flex';
            if (nextBtn) nextBtn.style.display = 'flex';
            
            // Add event listeners
            setTimeout(() => {
                const newPrevBtn = document.getElementById('fullScreenPrevBtn');
                const newNextBtn = document.getElementById('fullScreenNextBtn');
                
                if (newPrevBtn) {
                    newPrevBtn.onclick = showPreviousImage;
                }
                if (newNextBtn) {
                    newNextBtn.onclick = showNextImage;
                }
                
                // Add click handlers for images in preview
                addPreviewImageClickHandlers();
            }, 0);
            
            modal.style.display = 'block';
        }

        // Function to create preview content with navigation
        function createPreviewContentWithNavigation(question, questionNumber) {
            const inputImage = question.imageInput || '';
            const outputs = question.outputs || [];
            
            console.log('🔍 DEBUG createPreviewContentWithNavigation - inputImage:', inputImage);
            console.log('🔍 DEBUG createPreviewContentWithNavigation - outputs:', outputs);
            
            // Process output images
            const outputImages = outputs.map((output, index) => {
                let imageUrl = '';
                
                if (typeof output === 'string') {
                    imageUrl = output;
                } else if (output.image) {
                    imageUrl = output.image;
                } else if (output.url) {
                    imageUrl = output.url;
                }
                
                console.log(`🔍 DEBUG output ${index}:`, { output, imageUrl });
                
                return {
                    url: imageUrl,
                    title: `Output ${index + 1}`,
                    type: 'output'
                };
            }).filter(img => img.url && img.url.trim() !== '');
            
            console.log('🔍 DEBUG filtered outputImages:', outputImages);
            
            return `
                <div class="preview-container">
                    <div class="preview-left">
                        <div class="input-image-section">
                            <h3 class="section-title">Input Image</h3>
                            <div class="input-image-container">
                                ${inputImage ? 
                                    `<img src="${inputImage}" alt="Input Image" class="preview-input-image" style="cursor: pointer;" onerror="console.error('Failed to load input image:', this.src); this.style.display='none';" onload="console.log('Input image loaded successfully:', this.src);">` :
                                    '<div class="no-image-placeholder">No input image</div>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-right">
                        <div class="output-images-section">
                            <h3 class="section-title">Output Images (${outputImages.length})</h3>
                            <div class="output-grid">
                                ${outputImages.map((img, index) => `
                                    <div class="output-item" style="cursor: pointer;">
                                        <img src="${img.url}" alt="${img.title}" class="preview-output-image" onerror="console.error('Failed to load output image:', this.src); this.style.display='none';" onload="console.log('Output image loaded successfully:', this.src);">
        
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
                
                
            `;
        }

        // Function to update modal image
        function updateModalImage() {
            console.log('updateModalImage called - currentImageIndex:', currentImageIndex);
            console.log('Current images length:', currentImages.length);
            
            const modalImage = document.getElementById('fullScreenImage');
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            if (!currentImages || currentImages.length === 0) {
                console.log('Current images not found');
                return;
            }
            
            const currentImage = currentImages[currentImageIndex];
            console.log('Current image:', currentImage);
            
            // Check if we're in preview mode (no modalImage element)
            if (!modalImage) {
                // We're in preview mode, update the preview content
                updatePreviewContent(currentImage);
                return;
            }
            
            // Regular image mode
            modalImage.src = currentImage.url;
            
            // Update title based on image structure
                        // Update title based on image structure
            if (currentQuestionNumber > 0) {
                // Always include Request number when available
                modalTitle.textContent = `Request #${currentQuestionNumber} - ${currentImage.title || currentImage.type || 'Image'}`;
            } else if (currentQuestionIndex >= 0) {
                // For images from showAllQuestionImages
                const question = questions[currentQuestionIndex];
                const actualQuestionNumber = question ? (question.stt_doc || ((currentPage - 1) * itemsPerPage + currentQuestionIndex + 1)) : (currentPage - 1) * itemsPerPage + currentQuestionIndex + 1;
                modalTitle.textContent = `Request #${actualQuestionNumber} - ${currentImage.title || currentImage.type || 'Image'}`;
            } else if (currentImage.title) {
                // Fallback - only show title if no question number available
                modalTitle.textContent = currentImage.title;
            } else {
                // Final fallback
                modalTitle.textContent = 'Image';
            }
            
            if (imageCounter) imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            
            // Show/hide navigation buttons based on image count
            if (currentImages.length > 1) {
                // Always show both buttons for infinite loop
                if (prevBtn) prevBtn.style.display = 'flex';
                if (nextBtn) nextBtn.style.display = 'flex';
            } else {
                // Hide both buttons if only one image
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            }
            
            // Never disable buttons for infinite loop
            if (prevBtn) prevBtn.disabled = false;
            if (nextBtn) nextBtn.disabled = false;
        }

        // Function to update preview content
        function updatePreviewContent(currentImage) {
            const modalTitle = document.getElementById('fullScreenTitle');
            const imageCounter = document.getElementById('fullScreenCounter');
            
            // Update title
            if (currentImage.title) {
                modalTitle.textContent = currentImage.title;
            } else {
                modalTitle.textContent = 'Preview';
            }
            
            // Update counter
            if (imageCounter) {
                imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
            }
            
            // Update highlighted images
            updateHighlightedImages(currentImage);
        }

        // Function to update highlighted images in preview
        function updateHighlightedImages(currentImage) {
            // Remove all highlights
            const inputImage = document.querySelector('.preview-input-image');
            const outputItems = document.querySelectorAll('.output-item');
            
            if (inputImage) {
                inputImage.classList.remove('highlighted');
            }
            
            outputItems.forEach(item => {
                item.classList.remove('highlighted');
            });
            
            // Add highlight to current image
            if (currentImage) {
                if (currentImage.type === 'input') {
                    if (inputImage) {
                        inputImage.classList.add('highlighted');
                    }
                } else if (currentImage.type === 'output') {
                    outputItems.forEach(item => {
                        const img = item.querySelector('.preview-output-image');
                        if (img && img.src === currentImage.url) {
                            item.classList.add('highlighted');
                        }
                    });
                }
            }
        }

        // Function to close image modal
        function closeImageModal() {
            const modal = document.getElementById('fullScreenModal');
            const modalBody = document.querySelector('.fullscreen-body');
            
            // Reset modal body to original state
            modalBody.innerHTML = `
                <button class="fullscreen-nav-btn prev-btn" id="fullScreenPrevBtn">&lt;</button>
                <div class="fullscreen-image-container">
                    <img id="fullScreenImage" src="" alt="Full Screen Image">
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
            `;
            
            // Get the newly created elements
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            const imageCounter = document.getElementById('fullScreenCounter');
            
            // Show navigation elements
            if (prevBtn) prevBtn.style.display = 'flex';
            if (nextBtn) nextBtn.style.display = 'flex';
            if (imageCounter) imageCounter.style.display = 'block';
            
            modal.style.display = 'none';
            currentImages = [];
            currentImageIndex = 0;
            currentQuestionIndex = -1;
        }

        // Function to delete response
        async function deleteResponse(responseId) {
            if (!confirm('Are you sure you want to delete this response? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('https://surveyform-kxkk.onrender.com/delete-response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ responseId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                alert('Response deleted successfully!');
                
                // Reload current page
                loadAllResponses(currentPage);
                
            } catch (error) {
                console.error('Error deleting response:', error);
                alert('Failed to delete response. Please try again.');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Sử dụng Auth class để logout
                Auth.logout();
            }
        }

        // Navigation functionality
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all tabs
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Here you would implement the actual navigation logic
                console.log('Navigating to:', this.textContent);
            });
        });
    </script>
</body>
</html>

 