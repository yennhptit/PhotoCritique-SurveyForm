<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluate Request #2 - Image Evaluation System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.5;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }



        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .main-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .section-description {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .image-placeholder {
            width: 100%;
            height: 200px;
            background-color: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Input image container - same size as output images */
        .section .image-placeholder {
            max-width: 320px;
            height: 200px;
        }

        .image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .output-images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            align-items: start;
            margin-bottom: 24px;
        }

        .output-item {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .output-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .image-and-ranking {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }

        .rating-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .rating-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .rating-label {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            flex: 1;
        }

        .rating-input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #1f2937;
            text-align: center;
            flex-shrink: 0;
        }

        .rating-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .rating-input::-webkit-inner-spin-button,
        .rating-input::-webkit-outer-spin-button {
            opacity: 1;
        }

        .ranking-section {
            margin-top: 0;
        }

        .select-dropdown {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #1f2937;
            cursor: pointer;
        }

        .select-dropdown:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .comments-section {
            margin-top: 24px;
        }

        .comments-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            overflow: hidden;
        }

        .comments-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .submit-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .submit-button {
            background-color: #1f2937;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .submit-button:hover {
            background-color: #111827;
        }

        .submit-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .submit-button:disabled:hover {
            background-color: #9ca3af;
        }

        .icon {
            width: 16px;
            height: 16px;
        }

        /* Image Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }

        .close-modal:hover {
            color: #ccc;
        }

        .image-placeholder img {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .image-placeholder img:hover {
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .output-images-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            @media (min-width: 769px) and (max-width: 1024px) {
                .output-images-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 20px;
                }
            }
            
            .main-content {
                padding: 16px;
            }
            
            .section {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="page-title">Evaluate Request #2</h1>
    </header>

    <main class="main-content">
        <!-- Question Details -->
        <div class="section">
            <h2 class="section-title">Request</h2>
            <p class="section-description">Apply artistic style transfer to create a painting-like effect</p>
            
            <div class="subsection-title">Input Image</div>
            <div class="image-placeholder">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                </svg>
            </div>
        </div>

                 <!-- Output Images Container -->
         <div id="outputImagesContainer">
             <!-- Output images will be dynamically generated here -->
        </div>

        <!-- General Comments -->
        <div class="section">
                <h2 class="section-title">General Comments</h2>
                <p class="section-description">Provide overall feedback on the list of output images.</p>

            <div class="comments-section">
                <textarea 
                    class="comments-textarea" 
                    placeholder="Enter your general comments about the image outputs..."
                    id="general-comments"
                ></textarea>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <button class="submit-button" onclick="submitEvaluation()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                Submit Evaluation
            </button>
        </div>
    </main>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeImageModal()">&times;</button>
            <img id="modalImage" class="modal-image" src="" alt="Enlarged Image" onclick="closeImageModal()">
        </div>
    </div>

    <script>
        let currentQuestion = null;

        // Load question data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestionData();
        });

        function loadQuestionData() {
            const questionData = sessionStorage.getItem('evaluateQuestion');
            if (questionData) {
                currentQuestion = JSON.parse(questionData);
                console.log('Loaded question data:', currentQuestion);
                displayQuestionData();
            } else {
                alert('No question data found. Please go back to home page.');
                window.location.href = '/home.html';
            }
        }

        function displayQuestionData() {
            // Update page title
            document.title = `Evaluate Request #${currentQuestion.number} - Image Evaluation System`;
            document.querySelector('.page-title').textContent = `Evaluate Request #${currentQuestion.number}`;

            // Update question details
            document.querySelector('.section-description').textContent = currentQuestion.prompt;

            // Update input image
            const inputImagePlaceholder = document.querySelector('.section .image-placeholder');
            if (currentQuestion.imageInput) {
                inputImagePlaceholder.innerHTML = `<img src="${currentQuestion.imageInput}" alt="Input Image" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;" onclick="showImageModal('${currentQuestion.imageInput}', 'Input Image')">`;
            }

            // Update output images
            const outputImagesContainer = document.getElementById('outputImagesContainer');
            outputImagesContainer.innerHTML = ''; // Clear previous content

            // Create grid container
            const gridContainer = document.createElement('div');
            gridContainer.classList.add('output-images-grid');

            currentQuestion.outputs.forEach((output, index) => {
                const outputItem = document.createElement('div');
                outputItem.classList.add('output-item');
                outputItem.innerHTML = `
                    <h3 class="section-title">Output Image ${index + 1}</h3>
                    <div class="output-section">
                        <div class="image-and-ranking">
                            <div class="image-placeholder">
                                <img src="${output.image}" alt="Output Image ${index + 1}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;" onclick="showImageModal('${output.image}', 'Output Image ${index + 1}')">
                            </div>
                            
                            <div class="ranking-section">
                                <label class="rating-label">Ranking</label>
                                <select class="select-dropdown" id="ranking-${index + 1}">
                                    <option value="">Select ranking</option>
                                    ${generateRankingOptions(currentQuestion.outputs.length)}
                                </select>
                            </div>
                        </div>
                        
                        <div class="rating-controls">
                            <div class="rating-item">
                                <label class="rating-label">Overall Score:</label>
                                <input type="number" class="rating-input" id="overall-${index + 1}" min="1" max="100" placeholder="Score" onchange="validateRating(this)">
                            </div>
                            
                            <div class="rating-item">
                                <label class="rating-label">Accuracy:</label>
                                <input type="number" class="rating-input" id="accuracy-${index + 1}" min="1" max="100" placeholder="Score" onchange="validateRating(this)">
                            </div>
                            
                            <div class="rating-item">
                                <label class="rating-label">Naturalness:</label>
                                <input type="number" class="rating-input" id="naturalness-${index + 1}" min="1" max="100" placeholder="Score" onchange="validateRating(this)">
                            </div>
                            
                            <div class="rating-item">
                                <label class="rating-label">Sharpness:</label>
                                <input type="number" class="rating-input" id="sharpness-${index + 1}" min="1" max="100" placeholder="Score" onchange="validateRating(this)">
                            </div>
                        </div>
                    </div>
                `;
                gridContainer.appendChild(outputItem);
            });

            outputImagesContainer.appendChild(gridContainer);
            
            // Add validation listeners after content is loaded
            addRankingValidationListeners();
            
            // Add form completion listeners
            addFormCompletionListeners();
            
            // Initially disable submit button
            const submitButton = document.querySelector('.submit-button');
            submitButton.disabled = true;
        }

        function generateRankingOptions(totalImages) {
            let options = '';
            for (let i = 1; i <= totalImages; i++) {
                options += `<option value="${i}">${i}${getOrdinalSuffix(i)} Place</option>`;
            }
            return options;
        }

        function getOrdinalSuffix(num) {
            if (num >= 11 && num <= 13) return 'th';
            switch (num % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        function validateRating(input) {
            const value = parseInt(input.value);
            if (value < 1) {
                input.value = 1;
            } else if (value > 100) {
                input.value = 100;
            }
        }

        async function submitEvaluation() {
            if (!currentQuestion) {
                alert('No question data found');
                return;
            }

            // Get current user info from sessionStorage
            const userInfo = sessionStorage.getItem('userInfo');
            if (!userInfo) {
                alert('User information not found. Please login again.');
                window.location.href = '/login.html';
                return;
            }

            const currentUser = JSON.parse(userInfo);

            // Disable submit button to prevent double submission
            const submitButton = document.querySelector('.submit-button');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            try {
                // Collect all ratings dynamically
                const ratings = {};
                currentQuestion.outputs.forEach((output, index) => {
                    const imageNumber = index + 1;
                    ratings[`image${imageNumber}`] = {
                        imageIndex: index + 1, // STT của ảnh
                        imageUrl: output.image,
                        overall: parseInt(document.getElementById(`overall-${imageNumber}`).value),
                        accuracy: parseInt(document.getElementById(`accuracy-${imageNumber}`).value),
                        naturalness: parseInt(document.getElementById(`naturalness-${imageNumber}`).value),
                        sharpness: parseInt(document.getElementById(`sharpness-${imageNumber}`).value),
                        ranking: parseInt(document.getElementById(`ranking-${imageNumber}`).value)
                    };
                });

                const evaluationData = {
                    userId: currentUser._id || currentUser.username,
                    questionId: currentQuestion.id,
                    questionNumber: currentQuestion.number,
                    ratings: ratings,
                    comments: document.getElementById('general-comments').value.trim()
                };

                console.log('Sending evaluation data:', evaluationData);

                // Send to server
                const response = await fetch('https://surveyform-1.onrender.com/save-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(evaluationData)
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('Evaluation saved successfully:', result);
                    alert('Evaluation submitted successfully!');
                    
                    // Clear session storage
                    sessionStorage.removeItem('evaluateQuestion');
                    
                    // Redirect back to home page
                    window.location.href = '/home.html';
                } else {
                    throw new Error(result.message || 'Failed to save evaluation');
                }

            } catch (error) {
                console.error('Error submitting evaluation:', error);
                alert('Failed to submit evaluation: ' + error.message);
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        }

        // Update ranking options to disable already selected rankings
        function updateRankingOptions() {
            const selects = document.querySelectorAll('.select-dropdown');
            const selectedValues = Array.from(selects).map(s => s.value).filter(v => v !== '');
            
            selects.forEach((select, selectIndex) => {
                const currentValue = select.value;
                const options = select.querySelectorAll('option');
                
                options.forEach((option, optionIndex) => {
                    if (optionIndex === 0) return; // Skip "Select ranking" option
                    
                    const optionValue = option.value;
                    const isCurrentSelect = select.value === optionValue;
                    const isSelectedByOthers = selectedValues.includes(optionValue) && !isCurrentSelect;
                    
                    if (isSelectedByOthers) {
                        option.disabled = true;
                        option.style.color = '#9ca3af';
                    } else {
                        option.disabled = false;
                        option.style.color = '#1f2937';
                    }
                });
            });
        }

        // Validate rankings to ensure no duplicates
        function validateRankings() {
            const selects = document.querySelectorAll('.select-dropdown');
            const values = Array.from(selects).map(s => s.value).filter(v => v !== '');
            const duplicates = values.filter((item, index) => values.indexOf(item) !== index);
            
            if (duplicates.length > 0) {
                alert('Each ranking can only be used once. Please select different rankings for each image.');
            }
            
            // Update options after validation
            updateRankingOptions();
        }

        // Add event listeners for ranking validation after dynamic content is loaded
        function addRankingValidationListeners() {
            document.querySelectorAll('.select-dropdown').forEach((select, index) => {
                select.addEventListener('change', function() {
                    validateRankings();
                });
            });
        }

        // Image Modal Functions
        function showImageModal(imageUrl, title) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageUrl;
            modalImage.alt = title;
            modal.style.display = 'block';
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // Auto-resize textarea function
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Add auto-resize functionality to comments textarea
        document.addEventListener('DOMContentLoaded', function() {
            const commentsTextarea = document.getElementById('general-comments');
            if (commentsTextarea) {
                // Auto-resize on input
                commentsTextarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                    checkFormCompletion();
                });
                
                // Auto-resize on focus (in case of pre-filled content)
                commentsTextarea.addEventListener('focus', function() {
                    autoResizeTextarea(this);
                });
            }
        });

        // Check if all form fields are completed
        function checkFormCompletion() {
            if (!currentQuestion) return;

            const submitButton = document.querySelector('.submit-button');
            let isComplete = true;

            // Check all rating inputs
            currentQuestion.outputs.forEach((output, index) => {
                const imageNumber = index + 1;
                const overall = document.getElementById(`overall-${imageNumber}`).value;
                const accuracy = document.getElementById(`accuracy-${imageNumber}`).value;
                const naturalness = document.getElementById(`naturalness-${imageNumber}`).value;
                const sharpness = document.getElementById(`sharpness-${imageNumber}`).value;
                const ranking = document.getElementById(`ranking-${imageNumber}`).value;

                if (!overall || !accuracy || !naturalness || !sharpness || !ranking) {
                    isComplete = false;
                }
            });

            // Check comments
            const comments = document.getElementById('general-comments').value.trim();
            if (!comments) {
                isComplete = false;
            }

            // Enable/disable submit button
            submitButton.disabled = !isComplete;
        }

        // Add form completion check to rating inputs
        function addFormCompletionListeners() {
            if (!currentQuestion) return;

            currentQuestion.outputs.forEach((output, index) => {
                const imageNumber = index + 1;
                
                // Add listeners to all rating inputs
                ['overall', 'accuracy', 'naturalness', 'sharpness'].forEach(type => {
                    const input = document.getElementById(`${type}-${imageNumber}`);
                    if (input) {
                        input.addEventListener('input', checkFormCompletion);
                    }
                });

                // Add listener to ranking dropdown
                const rankingSelect = document.getElementById(`ranking-${imageNumber}`);
                if (rankingSelect) {
                    rankingSelect.addEventListener('change', checkFormCompletion);
                }
            });
        }
    </script>
</body>
</html>