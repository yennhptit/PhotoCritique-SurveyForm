<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluate Request #2 - Image Evaluation System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.5;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }



        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .main-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .section-description {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .image-placeholder {
            width: 100%;
            height: 200px;
            background-color: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Input image container - same size as output images */
        .section .image-placeholder {
            max-width: 320px;
            height: 200px;
        }

        .image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .output-images-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            align-items: start;
            margin-bottom: 24px;
        }

        .output-item {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .output-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }


        .rating-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .rating-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .rating-label {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            flex: 1;
        }

        .rating-input {
            width: 60px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #1f2937;
            text-align: center;
            flex-shrink: 0;
        }

        .rating-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .rating-input::-webkit-inner-spin-button,
        .rating-input::-webkit-outer-spin-button {
            opacity: 1;
        }


        .submit-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .submit-button {
            background-color: #1f2937;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .submit-button:hover {
            background-color: #111827;
        }

        .submit-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .submit-button:disabled:hover {
            background-color: #9ca3af;
        }

        .icon {
            width: 16px;
            height: 16px;
        }

        /* Image Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .modal-image.image-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 1001;
        }

        .close-modal:hover {
            color: #ccc;
        }

        .image-placeholder img {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .image-placeholder img:hover {
            opacity: 0.8;
        }

        /* Lazy loading styles */
        .lazy {
            opacity: 0;
            transition: opacity 0.3s;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .lazy.loaded {
            opacity: 1;
            animation: none;
            background: none;
        }

        /* Image optimization */
        img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            transform: translateZ(0); /* Hardware acceleration */
            will-change: transform; /* Optimize for animations */
            backface-visibility: hidden; /* Prevent flickering */
        }

        /* Optimize image loading performance */
        .image-placeholder img {
            content-visibility: auto;
            contain: layout style paint;
        }

        /* Critical image loading - attributes are set in HTML */

        /* Lazy image loading */
        .lazy {
            content-visibility: auto;
            contain: layout style paint;
        }

        /* Progressive loading effect */
        .image-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Preview Modal Styles */
        .preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .preview-modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .preview-close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 2001;
        }

        .preview-close-modal:hover {
            color: #ccc;
        }

        .preview-gallery-container {
            display: flex;
            height: 100%;
            padding: 60px 20px 20px 20px;
                    gap: 20px;
                }

        .preview-left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .preview-right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .preview-section-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .preview-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .preview-modal-image {
            height: 100%;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .preview-modal-image:hover {
            transform: scale(1.02);
        }

        .preview-outputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 128px);
            gap: 20px;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #000000;
            justify-content: start;
            align-items: start;
        }

        .preview-output-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 150px;
            margin: 4px;
            flex-shrink: 0;
        }

        .preview-output-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .preview-output-item.active {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .preview-output-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            transition: opacity 0.3s ease;
        }

        .preview-output-image:not([src]) {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .preview-output-image.loading {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .preview-full-image {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .preview-full-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .preview-close-full-image {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 3001;
            padding: 10px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .preview-close-full-image:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Full Screen Modal Styles (like Home page) */
        .fullscreen-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
        }

        .fullscreen-overlay {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .fullscreen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3001;
        }

        .fullscreen-header h3 {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .fullscreen-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .fullscreen-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .fullscreen-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 80px 20px 20px 20px;
        }

        .fullscreen-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 90%;
            max-height: 90%;
        }

        .fullscreen-image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .fullscreen-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 3002;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .fullscreen-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .fullscreen-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .fullscreen-nav-btn:disabled:hover {
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
        }

        .fullscreen-nav-btn.prev-btn {
            left: 20px;
        }

        .fullscreen-nav-btn.next-btn {
            right: 20px;
        }

        /* Navigation buttons */
        .preview-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            font-weight: bold;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2002;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .preview-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .preview-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .preview-nav-btn:disabled:hover {
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
        }

        .preview-nav-prev {
            left: 20px;
        }

        .preview-nav-next {
            right: 20px;
        }

        /* Ensure navigation buttons are outside the gallery container */
        .preview-gallery-container {
            margin: 0 60px; /* Add margin to make space for navigation buttons */
        }

        @media (max-width: 1024px) {
            .preview-gallery-container {
                flex-direction: column;
                height: 90vh;
                margin: 0 60px; /* Keep margin for navigation buttons */
            }
            
            .preview-left-panel {
                flex: 0 0 30%;
                min-height: 200px;
            }
            
            .preview-outputs-grid {
                grid-template-columns: repeat(3, 128px);
                gap: 16px;
                padding: 16px;
                justify-content: center;
            }
        }
            
        @media (max-width: 768px) {
            .preview-outputs-grid {
                grid-template-columns: repeat(2, 128px);
                gap: 12px;
                padding: 12px;
                justify-content: center;
            }
            
            .preview-gallery-container {
                height: 85vh;
                margin: 0 60px; /* Keep margin for navigation buttons */
            }
            
            /* Adjust navigation button position for mobile */
            .preview-nav-prev {
                left: 10px;
            }
            
            .preview-nav-next {
                right: 10px;
            }
            
            .preview-left-panel {
                flex: 0 0 40%;
                min-height: 250px;
            }
            
            .output-images-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .main-content {
                padding: 16px;
            }
            
            .section {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="page-title">Evaluate Request #2</h1>
    </header>

    <main class="main-content">
        <!-- Question Details -->
        <div class="section">
            <h2 class="section-title">Request</h2>
            <p class="section-description">Loading...</p>
            
            <div class="subsection-title">Input Image</div>
            <div class="image-placeholder">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                </svg>
            </div>
        </div>

                 <!-- Output Images Container -->
         <div id="outputImagesContainer">
             <!-- Output images will be dynamically generated here -->
        </div>


        <!-- Submit Section -->
        <div class="submit-section">
            <button class="submit-button" onclick="submitEvaluation()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                Submit Evaluation
            </button>
        </div>
    </main>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeImageModal()">&times;</button>
            <img id="modalImage" class="modal-image" src="" alt="Enlarged Image" onclick="closeImageModal()">
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-modal-content">
            <button class="preview-close-modal" onclick="closePreviewModal()">&times;</button>
            
            <!-- Navigation buttons -->
            <button class="preview-nav-btn preview-nav-prev" id="previewPrevBtn" onclick="navigatePreviewImage(-1)">&lt;</button>
            <button class="preview-nav-btn preview-nav-next" id="previewNextBtn" onclick="navigatePreviewImage(1)">&gt;</button>
            
            <div class="preview-gallery-container">
                <div class="preview-left-panel">
                    <div class="preview-section-title">Input Image</div>
                    <div class="preview-image-container">
                        <img id="previewInputImage" class="preview-modal-image" src="" alt="Input Image" onclick="navigateToImage(this.src, 'Input Image')">
                    </div>
                </div>
                
                <div class="preview-right-panel">
                    <div class="preview-section-title">Output Images</div>
                    <div id="previewOutputsGrid" class="preview-outputs-grid">
                        <!-- Output images will be dynamically populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Full Image Modal -->
    <div id="previewFullImageModal" class="preview-full-image">
        <button class="preview-close-full-image" onclick="closePreviewFullImage()">&times;</button>
        <img id="previewFullImage" src="" alt="Full Size Image">
    </div>

    <!-- Full Screen Image Modal (like Home page) -->
    <div id="fullScreenModal" class="fullscreen-modal">
        <div class="fullscreen-overlay">
            <div class="fullscreen-header">
                <h3 id="fullScreenTitle">Image View</h3>
                <span class="fullscreen-close" id="closeFullScreenModal">&times;</span>
            </div>
            <div class="fullscreen-body">
                <button class="fullscreen-nav-btn prev-btn" id="fullScreenPrevBtn">&lt;</button>
                <div class="fullscreen-image-container">
                    <img id="fullScreenImage" src="" alt="Full Screen Image">
                </div>
                <button class="fullscreen-nav-btn next-btn" id="fullScreenNextBtn">&gt;</button>
            </div>
        </div>
    </div>

    <script>
        let currentQuestion = null;
        let imageObserver;
        let previewCurrentImageIndex = 0;
        let previewAllImages = [];
        let currentImages = [];
        let currentImageIndex = 0;

        // Load question data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initImageObserver();
            loadQuestionData();
            setupFullScreenModal();
        });

        // Setup fullscreen modal event listeners
        function setupFullScreenModal() {
            const fullScreenModal = document.getElementById('fullScreenModal');
            const closeFullScreenModalBtn = document.getElementById('closeFullScreenModal');
            const fullScreenPrevBtn = document.getElementById('fullScreenPrevBtn');
            const fullScreenNextBtn = document.getElementById('fullScreenNextBtn');
            
            if (closeFullScreenModalBtn) {
                closeFullScreenModalBtn.addEventListener('click', closeFullScreenModal);
            }
            
            if (fullScreenPrevBtn) {
                fullScreenPrevBtn.addEventListener('click', showPreviousImage);
            }
            
            if (fullScreenNextBtn) {
                fullScreenNextBtn.addEventListener('click', showNextImage);
            }
            
            // Close modal when clicking outside
            if (fullScreenModal) {
                fullScreenModal.addEventListener('click', function(e) {
                    if (e.target === fullScreenModal) {
                        closeFullScreenModal();
                    }
                });
            }
        }

        // Function to preload images with priority and caching
        function preloadImages(imageUrls) {
            const imagePromises = imageUrls.map(url => {
                if (!url || url.trim() === '') return Promise.resolve();
                
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    // Enable cross-origin for better caching
                    img.crossOrigin = 'anonymous';
                    
                    // Add loading optimization attributes
                    img.loading = 'eager';
                    img.decoding = 'async';
                    
                    img.onload = () => {
                        console.log('Preloaded image:', url);
                        resolve();
                    };
                    
                    img.onerror = () => {
                        console.warn('Failed to preload image:', url);
                        resolve(); // Don't reject, just continue
                    };
                    
                    // Set src after setting up handlers
                    img.src = url;
                });
            });
            
            return Promise.all(imagePromises);
        }

        // Enhanced preload with priority
        async function preloadImagesWithPriority() {
            const imagesToPreload = [];
            
            // Priority 1: Input image (most important)
            if (currentQuestion.imageInput) {
                imagesToPreload.push({
                    url: currentQuestion.imageInput,
                    priority: 1,
                    type: 'input'
                });
            }
            
            // Priority 2: First 2 output images
            if (currentQuestion.outputs) {
                currentQuestion.outputs.slice(0, 2).forEach((output, index) => {
                    let imageUrl = '';
                    if (typeof output === 'string') {
                        imageUrl = output;
                    } else if (output.image) {
                        imageUrl = output.image;
                    } else if (output.url) {
                        imageUrl = output.url;
                    }
                    
                    if (imageUrl) {
                        imagesToPreload.push({
                            url: imageUrl,
                            priority: 2,
                            type: 'output',
                            index: index
                        });
                    }
                });
            }
            
            // Sort by priority
            imagesToPreload.sort((a, b) => a.priority - b.priority);
            
            console.log('Preloading images with priority:', imagesToPreload);
            
            // Preload in batches for better performance
            const batchSize = 3;
            for (let i = 0; i < imagesToPreload.length; i += batchSize) {
                const batch = imagesToPreload.slice(i, i + batchSize);
                const urls = batch.map(img => img.url);
                
                try {
                    await preloadImages(urls);
                    console.log(`Preloaded batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(imagesToPreload.length/batchSize)}`);
                } catch (error) {
                    console.warn('Error preloading batch:', error);
                }
                
                // Small delay between batches to prevent overwhelming the browser
                if (i + batchSize < imagesToPreload.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
        }

        // Intersection Observer for advanced lazy loading
        function initImageObserver() {
            if ('IntersectionObserver' in window) {
                imageObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                // Add loading optimization
                                img.loading = 'eager';
                                img.fetchpriority = 'high';
                                
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                                img.classList.remove('lazy');
                                img.classList.add('loaded');
                                
                                // Unobserve after loading
                                imageObserver.unobserve(img);
                            }
                        }
                    });
                }, {
                    rootMargin: '100px 0px', // Increased margin for earlier loading
                    threshold: 0.01,
                    trackVisibility: true, // Better performance tracking
                    delay: 100 // Small delay to batch operations
                });
            }
        }

        // Enhanced image loading with retry mechanism
        function loadImageWithRetry(img, src, maxRetries = 3) {
            let retryCount = 0;
            
            const attemptLoad = () => {
                img.onload = () => {
                    console.log('Image loaded successfully:', src);
                    img.classList.add('loaded');
                    img.style.opacity = '1';
                };
                
                img.onerror = () => {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.warn(`Retrying image load (${retryCount}/${maxRetries}):`, src);
                        setTimeout(attemptLoad, 1000 * retryCount); // Exponential backoff
                    } else {
                        console.error('Failed to load image after retries:', src);
                        img.style.display = 'none';
                    }
                };
                
                img.src = src;
            };
            
            attemptLoad();
        }

        // Function to create optimized lazy image element
        function createLazyImage(src, alt, className = '', style = '', onclick = '') {
            const optimizedStyle = `${style} image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; transform: translateZ(0);`;
            
            if ('IntersectionObserver' in window) {
                return `<img data-src="${src}" alt="${alt}" class="lazy ${className}" style="${optimizedStyle}" loading="lazy" decoding="async" fetchpriority="high" ${onclick}>`;
            } else {
                return `<img src="${src}" alt="${alt}" class="${className}" style="${optimizedStyle}" loading="eager" decoding="async" fetchpriority="high" ${onclick}>`;
            }
        }

        // Function to create eager loading image (for critical images)
        function createEagerImage(src, alt, className = '', style = '', onclick = '') {
            const optimizedStyle = `${style} image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; transform: translateZ(0);`;
            return `<img src="${src}" alt="${alt}" class="${className}" style="${optimizedStyle}" loading="eager" decoding="async" fetchpriority="high" ${onclick}>`;
        }

        async function loadQuestionData() {
            const questionData = sessionStorage.getItem('evaluateQuestion');
            if (questionData) {
                currentQuestion = JSON.parse(questionData);
                console.log('Loaded question data:', currentQuestion);
                
                // Load existing response if available
                await loadExistingResponse();
                
                displayQuestionData();
            } else {
                alert('No question data found. Please go back to home page.');
                window.location.href = '/home.html';
            }
        }

        // Load existing response for this user and question
        async function loadExistingResponse() {
            try {
                // Get current user info
                const userInfo = sessionStorage.getItem('userInfo');
                if (!userInfo) return;

                const currentUser = JSON.parse(userInfo);
                const userId = currentUser._id || currentUser.username;
                const questionId = currentQuestion.id;

                console.log('Loading existing response for userId:', userId, 'questionId:', questionId);

                // Fetch existing response
                const response = await fetch(`https://surveyform-kxkk.onrender.com/get-response?userId=${encodeURIComponent(userId)}&questionId=${encodeURIComponent(questionId)}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.response && result.response.ratings) {
                        console.log('Found existing response:', result.response);
                        currentQuestion.existingResponse = result.response;
                    }
                } else {
                    console.log('No existing response found or error:', response.status);
                }
            } catch (error) {
                console.error('Error loading existing response:', error);
            }
        }

        function displayQuestionData() {
            // Update page title
            document.title = `Evaluate Request #${currentQuestion.number} - Image Evaluation System`;
            document.querySelector('.page-title').textContent = `Evaluate Request #${currentQuestion.number}`;

            // Update question details
            document.querySelector('.section-description').textContent = currentQuestion.prompt;

            // Update input image with eager loading (critical image)
            const inputImagePlaceholder = document.querySelector('.section .image-placeholder');
            if (currentQuestion.imageInput) {
                inputImagePlaceholder.innerHTML = createEagerImage(
                    currentQuestion.imageInput, 
                    "Input Image", 
                    '', 
                    'width: 100%; height: 100%; object-fit: cover; border-radius: 6px;',
                    `onclick="showImageModal('${currentQuestion.imageInput}', 'Input Image')" onload="this.classList.add('loaded'); this.style.opacity='1';" onerror="this.style.display='none';"`
                );
            }

            // Update output images
            const outputImagesContainer = document.getElementById('outputImagesContainer');
            outputImagesContainer.innerHTML = ''; // Clear previous content

            // Create grid container
            const gridContainer = document.createElement('div');
            gridContainer.classList.add('output-images-grid');

            currentQuestion.outputs.forEach((output, index) => {
                const outputItem = document.createElement('div');
                outputItem.classList.add('output-item');
                
                // Handle different output structures
                let imageUrl = '';
                if (typeof output === 'string') {
                    imageUrl = output;
                } else if (output.image) {
                    imageUrl = output.image;
                } else if (output.url) {
                    imageUrl = output.url;
                }
                
                outputItem.innerHTML = `
                    <h3 class="section-title">Output Image ${index + 1}</h3>
                    <div class="output-section">
                        <div class="image-placeholder">
                            ${createLazyImage(
                                imageUrl, 
                                `Output Image ${index + 1}`, 
                                '', 
                                'width: 100%; height: 100%; object-fit: cover; border-radius: 6px;',
                                `onclick="showImageModal('${imageUrl}', 'Output Image ${index + 1}')" onload="this.classList.add('loaded'); this.style.opacity='1';" onerror="this.style.display='none';"`
                            )}
                        </div>
                        
                        <div class="rating-controls">
                            <div class="rating-item">
                                <label class="rating-label">Instruction Following:</label>
                                <input type="number" class="rating-input" id="instruction-${index + 1}" min="1" max="5" step="1" placeholder="1-5" onchange="validateRating(this)">
                            </div>
                            
                            <div class="rating-item">
                                <label class="rating-label">Aesthetic:</label>
                                <input type="number" class="rating-input" id="aesthetic-${index + 1}" min="1" max="5" step="1" placeholder="1-5" onchange="validateRating(this)">
                            </div>
                            
                            <div class="rating-item">
                                <label class="rating-label">Destruction:</label>
                                <input type="number" class="rating-input" id="destruction-${index + 1}" min="1" max="5" step="1" placeholder="1-5" onchange="validateRating(this)">
                            </div>
                        </div>
                    </div>
                `;
                gridContainer.appendChild(outputItem);
            });

            outputImagesContainer.appendChild(gridContainer);
            
            // Observe lazy images after rendering
            if (imageObserver) {
                const lazyImages = document.querySelectorAll('img.lazy');
                lazyImages.forEach(img => imageObserver.observe(img));
            }
            
            // Start preloading images with priority (non-blocking)
            preloadImagesWithPriority().catch(error => {
                console.warn('Error preloading images:', error);
            });
            
            // Add form completion listeners
            addFormCompletionListeners();
            
            // Load existing response data if available
            loadExistingResponseData();
            
            // Initially disable submit button
            const submitButton = document.querySelector('.submit-button');
            submitButton.disabled = true;
        }

        // Load existing response data into form fields
        function loadExistingResponseData() {
            if (!currentQuestion.existingResponse || !currentQuestion.existingResponse.ratings) {
                console.log('No existing response data to load');
                return;
            }

            console.log('Loading existing response data:', currentQuestion.existingResponse.ratings);

            // Map existing ratings by type for easy lookup
            const ratingsByType = {};
            Object.values(currentQuestion.existingResponse.ratings).forEach(rating => {
                if (rating.type) {
                    ratingsByType[rating.type] = rating;
                }
            });

            console.log('Ratings by type:', ratingsByType);

            // Fill form fields based on output type
            currentQuestion.outputs.forEach((output, index) => {
                const imageNumber = index + 1;
                
                // Get output type
                let outputType = '';
                if (typeof output === 'string') {
                    // For string outputs, we can't determine type, use imageNumber as fallback
                    outputType = `image${imageNumber}`;
                } else if (output.type) {
                    outputType = output.type;
                } else {
                    // Fallback to imageNumber if no type
                    outputType = `image${imageNumber}`;
                }

                console.log(`Output ${imageNumber} type:`, outputType);

                // Find matching rating by type
                let matchingRating = null;
                
                // First try to find by exact type match
                if (ratingsByType[outputType]) {
                    matchingRating = ratingsByType[outputType];
                } else {
                    // Fallback: try to find by imageNumber
                    const ratingKey = `image${imageNumber}`;
                    if (currentQuestion.existingResponse.ratings[ratingKey]) {
                        matchingRating = currentQuestion.existingResponse.ratings[ratingKey];
                    }
                }

                if (matchingRating) {
                    console.log(`Found matching rating for output ${imageNumber}:`, matchingRating);
                    
                    // Fill the form fields
                    const instructionInput = document.getElementById(`instruction-${imageNumber}`);
                    const aestheticInput = document.getElementById(`aesthetic-${imageNumber}`);
                    const destructionInput = document.getElementById(`destruction-${imageNumber}`);

                    if (instructionInput && matchingRating.instruction) {
                        instructionInput.value = matchingRating.instruction;
                    }
                    if (aestheticInput && matchingRating.aesthetic) {
                        aestheticInput.value = matchingRating.aesthetic;
                    }
                    if (destructionInput && matchingRating.destruction) {
                        destructionInput.value = matchingRating.destruction;
                    }
                } else {
                    console.log(`No matching rating found for output ${imageNumber} with type ${outputType}`);
                }
            });

            // Check form completion after loading data
            checkFormCompletion();
        }

        function validateRating(input) {
            const value = parseInt(input.value);
            if (isNaN(value) || value < 1) {
                input.value = 1;
            } else if (value > 5) {
                input.value = 5;
            } else {
                // Ensure it's an integer
                input.value = Math.floor(value);
            }
        }

        async function submitEvaluation() {
            if (!currentQuestion) {
                alert('No question data found');
                return;
            }

            // Get current user info from sessionStorage
            const userInfo = sessionStorage.getItem('userInfo');
            if (!userInfo) {
                alert('User information not found. Please login again.');
                window.location.href = '/login.html';
                return;
            }

            const currentUser = JSON.parse(userInfo);

            // Disable submit button to prevent double submission
            const submitButton = document.querySelector('.submit-button');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            try {
                // Collect all ratings dynamically
                const ratings = {};
                currentQuestion.outputs.forEach((output, index) => {
                    const imageNumber = index + 1;
                    
                    // Handle different output structures
                    let imageUrl = '';
                    let type = '';
                    if (typeof output === 'string') {
                        imageUrl = output;
                    } else if (output.image) {
                        imageUrl = output.image;
                        type = output.type || '';
                    } else if (output.url) {
                        imageUrl = output.url;
                        type = output.type || '';
                    }
                    
                    ratings[`image${imageNumber}`] = {
                        imageIndex: index + 1, // STT của ảnh
                        imageUrl: imageUrl,
                        type: type,
                        instruction: parseInt(document.getElementById(`instruction-${imageNumber}`).value),
                        aesthetic: parseInt(document.getElementById(`aesthetic-${imageNumber}`).value),
                        destruction: parseInt(document.getElementById(`destruction-${imageNumber}`).value)
                    };
                });

                const evaluationData = {
                    userId: currentUser._id || currentUser.username,
                    questionId: currentQuestion.id,
                    questionNumber: currentQuestion.number,
                    ratings: ratings,
                    comments: '' // Add empty comments to be compatible with current server
                };

                console.log('Sending evaluation data:', evaluationData);

                // Send to server
                const response = await fetch('https://surveyform-kxkk.onrender.com/save-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(evaluationData)
                });

                const result = await response.json();

                if (response.ok) {
                    console.log('Evaluation saved successfully:', result);
                    alert('Evaluation submitted successfully!');
                    
                    // Clear session storage
                    sessionStorage.removeItem('evaluateQuestion');
                    
                    // Redirect back to home page
                    window.location.href = '/home.html';
                } else {
                    throw new Error(result.message || 'Failed to save evaluation');
                }

            } catch (error) {
                console.error('Error submitting evaluation:', error);
                alert('Failed to submit evaluation: ' + error.message);
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        }


        // Image Modal Functions
        function showImageModal(imageUrl, title) {
            // Show preview modal and navigate to specific image
            showPreviewModal(false); // Don't reset index
            
            // Navigate to the specific image
            navigateToImage(imageUrl, title);
        }

        // Navigate to specific image in preview modal
        function navigateToImage(imageUrl, title) {
            if (currentQuestion) {
                let targetIndex = -1;
                
                // Check if it's input image
                if (currentQuestion.imageInput === imageUrl) {
                    targetIndex = 0; // Input image is always index 0
                } else {
                    // Check output images
                    if (currentQuestion.outputs) {
                        currentQuestion.outputs.forEach((output, index) => {
                            let outputUrl = '';
                            if (typeof output === 'string') {
                                outputUrl = output;
                            } else if (output.image) {
                                outputUrl = output.image;
                            } else if (output.url) {
                                outputUrl = output.url;
                            }
                            
                            if (outputUrl === imageUrl) {
                                targetIndex = index + 1; // Output images start from index 1
                            }
                        });
                    }
                }
                
                // Navigate to the specific image
                if (targetIndex >= 0) {
                    previewCurrentImageIndex = targetIndex;
                    
                    if (targetIndex === 0) {
                        // Input image - show single input view
                        showSingleInputImage();
                    } else {
                        // Output image - show single output view
                        showSingleOutputImage(targetIndex - 1);
                    }
                }
            }
        }

        // Preview Modal Functions
        function showPreviewModal(resetIndex = true) {
            if (!currentQuestion) {
                console.error('No current question data available');
                return;
            }
            
            // Prepare all images array for navigation
            preparePreviewAllImagesArray();
            
            const modal = document.getElementById('previewModal');
            const previewInputImage = document.getElementById('previewInputImage');
            const previewOutputsGrid = document.getElementById('previewOutputsGrid');
            
            // Set input image
            if (currentQuestion.imageInput) {
                previewInputImage.src = currentQuestion.imageInput;
                previewInputImage.alt = 'Input Image';
            }
            
            // Clear and populate output images grid
            previewOutputsGrid.innerHTML = '';
            
            if (currentQuestion.outputs && currentQuestion.outputs.length > 0) {
                currentQuestion.outputs.forEach((output, i) => {
                    let imageUrl = '';
                    if (typeof output === 'string') {
                        imageUrl = output;
                    } else if (output.image) {
                        imageUrl = output.image;
                    } else if (output.url) {
                        imageUrl = output.url;
                    }
                    
                    if (imageUrl) {
                        const outputItem = document.createElement('div');
                        outputItem.classList.add('preview-output-item');
                        
                        outputItem.innerHTML = `
                            <img class="preview-output-image loading" src="${imageUrl}" alt="Output Image ${i+1}" 
                                 onclick="navigateToImage('${imageUrl}', 'Output Image ${i+1}')" 
                                 loading="eager" decoding="async" fetchpriority="high"
                                 onload="this.classList.remove('loading'); console.log('Output image loaded:', ${i+1})" 
                                 onerror="this.classList.remove('loading'); console.error('Failed to load output image:', ${i+1})">
                        `;
                        
                        previewOutputsGrid.appendChild(outputItem);
                    }
                });
            } else {
                previewOutputsGrid.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">No output images available</div>';
            }
            
            // Only reset current image index if requested
            if (resetIndex) {
                previewCurrentImageIndex = 0;
            }
            
            // Show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Start with 2-column view only if we're resetting
            if (resetIndex) {
                showTwoColumnPreview();
            }
        }
    
    // Prepare all images array for navigation
        function preparePreviewAllImagesArray() {
    previewAllImages = [];
    
    // Add input image
            if (currentQuestion.imageInput) {
        previewAllImages.push({
            type: 'input',
            index: 0,
                    url: currentQuestion.imageInput,
            title: 'Input Image'
        });
    }
    
    // Add output images
            if (currentQuestion.outputs && currentQuestion.outputs.length > 0) {
                currentQuestion.outputs.forEach((output, index) => {
            let imageUrl = '';
            if (typeof output === 'string') {
                imageUrl = output;
            } else if (output.image) {
                imageUrl = output.image;
            } else if (output.url) {
                imageUrl = output.url;
            }
            
            if (imageUrl) {
                previewAllImages.push({
                    type: 'output',
                    index: index,
                    url: imageUrl,
                    title: `Output Image ${index + 1}`
                });
            }
        });
    }
    
    console.log('Preview all images prepared:', previewAllImages);
}

        // Navigate through images
        function navigatePreviewImage(direction) {
            if (previewAllImages.length === 0) return;
            
            // Check if we're in 2-column view
            const previewLeftPanel = document.querySelector('.preview-left-panel');
            const previewRightPanel = document.querySelector('.preview-right-panel');
            const isTwoColumnView = previewLeftPanel && previewRightPanel && 
                                  previewLeftPanel.style.display !== 'none' && 
                                  previewRightPanel.style.display !== 'none';
            
            if (isTwoColumnView) {
                // From 2-column view: go to Input Image (index 0)
                if (direction > 0) {
                    previewCurrentImageIndex = 0;
                    showSingleInputImage();
                }
                return;
            }
            
            // From single view: navigate normally
            previewCurrentImageIndex += direction;
            
            // Handle bounds with custom logic
            if (previewCurrentImageIndex < 0) {
                // Go back to 2-column preview
                showTwoColumnPreview();
                return;
            } else if (previewCurrentImageIndex >= previewAllImages.length) {
                // Go back to 2-column preview
                showTwoColumnPreview();
                return;
            }
            
            const currentImage = previewAllImages[previewCurrentImageIndex];
            
            // Show image in same preview modal
            if (currentImage.type === 'input') {
                showSingleInputImage();
            } else {
                showSingleOutputImage(currentImage.index);
            }
        }

        // Show two-column preview (default view)
        function showTwoColumnPreview() {
            const previewLeftPanel = document.querySelector('.preview-left-panel');
            const previewRightPanel = document.querySelector('.preview-right-panel');
            
            // Show both panels
            if (previewLeftPanel) {
                previewLeftPanel.style.display = 'flex';
                previewLeftPanel.style.flex = '1';
                previewLeftPanel.style.width = 'auto'; // Reset width
            }
            if (previewRightPanel) {
                previewRightPanel.style.display = 'flex';
                previewRightPanel.style.flex = '1';
                previewRightPanel.style.width = 'auto'; // Reset width
            }
            
            // Reset section titles to original
            const leftSectionTitle = previewLeftPanel.querySelector('.preview-section-title');
            if (leftSectionTitle) {
                leftSectionTitle.textContent = 'Input Image';
            }
            
            const rightSectionTitle = previewRightPanel.querySelector('.preview-section-title');
            if (rightSectionTitle) {
                rightSectionTitle.textContent = 'Output Images';
            }
            
            // Reset input image to original
            const previewInputImage = document.getElementById('previewInputImage');
            if (previewInputImage && currentQuestion && currentQuestion.imageInput) {
                previewInputImage.src = currentQuestion.imageInput;
                previewInputImage.alt = 'Input Image';
            }
            
            // Reset current image index to 0 (input image)
            previewCurrentImageIndex = 0;
    
    // Update navigation buttons
    updatePreviewNavigationButtons();
}

        // Show single input image view (in preview modal)
        function showSingleInputImage() {
            const previewLeftPanel = document.querySelector('.preview-left-panel');
            const previewRightPanel = document.querySelector('.preview-right-panel');
            
            // Show only left panel (input image) - full screen
            if (previewLeftPanel) {
                previewLeftPanel.style.display = 'flex';
                previewLeftPanel.style.flex = '1';
                previewLeftPanel.style.width = '100%';
            }
            
            // Hide right panel (output images)
            if (previewRightPanel) previewRightPanel.style.display = 'none';
            
            // Update section title
            const sectionTitle = previewLeftPanel.querySelector('.preview-section-title');
            if (sectionTitle) {
                sectionTitle.textContent = 'Input Image';
            }
            
            // Ensure the input image is displayed correctly
            const previewInputImage = document.getElementById('previewInputImage');
            if (previewInputImage && currentQuestion && currentQuestion.imageInput) {
                previewInputImage.src = currentQuestion.imageInput;
                previewInputImage.alt = 'Input Image';
            }
            
            // Update navigation buttons for input image
            updatePreviewNavigationButtons();
        }

        // Show single output image view (in preview modal)
        function showSingleOutputImage(outputIndex) {
            const previewLeftPanel = document.querySelector('.preview-left-panel');
            const previewRightPanel = document.querySelector('.preview-right-panel');
            
            // Show only left panel (like input image) - full screen
            if (previewLeftPanel) {
                previewLeftPanel.style.display = 'flex';
                previewLeftPanel.style.flex = '1';
                previewLeftPanel.style.width = '100%';
            }
            
            // Hide right panel (output images)
            if (previewRightPanel) previewRightPanel.style.display = 'none';
            
            // Update section title
            const sectionTitle = previewLeftPanel.querySelector('.preview-section-title');
            if (sectionTitle) {
                sectionTitle.textContent = `Output Image ${outputIndex + 1}`;
            }
            
            // Get the current output image URL
            const currentImage = previewAllImages[previewCurrentImageIndex];
            if (currentImage && currentImage.url) {
                // Update the input image container to show the output image
                const previewInputImage = document.getElementById('previewInputImage');
                if (previewInputImage) {
                    previewInputImage.src = currentImage.url;
                    previewInputImage.alt = `Output Image ${outputIndex + 1}`;
                }
            }
            
            // Update navigation buttons for output image
            updatePreviewNavigationButtons();
        }

        // Show fullscreen image (like Home page)
        function showFullScreenImage(imageUrl, title) {
            const modal = document.getElementById('fullScreenModal');
            const modalImage = document.getElementById('fullScreenImage');
            const modalTitle = document.getElementById('fullScreenTitle');
            const prevBtn = document.getElementById('fullScreenPrevBtn');
            const nextBtn = document.getElementById('fullScreenNextBtn');
            
            // Set current images and index
            currentImages = previewAllImages.map(img => img.url);
            currentImageIndex = previewCurrentImageIndex;
            
            // Update modal content
            modalImage.src = imageUrl;
            modalTitle.textContent = `Request #${currentQuestion.number} - ${title}`;
            
            // Show navigation buttons
            if (prevBtn) prevBtn.style.display = 'flex';
            if (nextBtn) nextBtn.style.display = 'flex';
            
            // Special logic for Input Image (index 0)
            if (currentImageIndex === 0) {
                // Input Image: < goes back to preview, > goes to next image
                if (prevBtn) {
                    prevBtn.disabled = false;
                    prevBtn.onclick = () => {
                        // Go back to 2-column preview
                        closeFullScreenModal();
                        showTwoColumnPreview();
                    };
                }
                if (nextBtn) {
                    nextBtn.disabled = (previewAllImages.length <= 1);
                    nextBtn.onclick = () => showNextImage();
                }
    } else {
                // Output Images: < goes to previous image, > goes to next image
                if (prevBtn) {
                    prevBtn.disabled = false;
                    prevBtn.onclick = () => showPreviousImage();
                }
                if (nextBtn) {
                    nextBtn.disabled = (currentImageIndex === currentImages.length - 1);
                    nextBtn.onclick = () => showNextImage();
                }
            }
            
            // Hide preview modal and show fullscreen modal
            document.getElementById('previewModal').style.display = 'none';
            modal.style.display = 'block';
        }

        // Show previous image in fullscreen
        function showPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                previewCurrentImageIndex = currentImageIndex;
                const currentImage = previewAllImages[currentImageIndex];
                if (currentImage) {
                    showFullScreenImage(currentImage.url, currentImage.title);
                }
            }
        }

        // Show next image in fullscreen
        function showNextImage() {
            if (currentImageIndex < currentImages.length - 1) {
                currentImageIndex++;
                previewCurrentImageIndex = currentImageIndex;
                const currentImage = previewAllImages[currentImageIndex];
                if (currentImage) {
                    showFullScreenImage(currentImage.url, currentImage.title);
                }
            } else {
                // If at last image, go back to 2-column preview
                closeFullScreenModal();
                showTwoColumnPreview();
            }
        }

        // Close fullscreen modal and return to preview
        function closeFullScreenModal() {
            const modal = document.getElementById('fullScreenModal');
            modal.style.display = 'none';
            
            // Return to preview modal
            document.getElementById('previewModal').style.display = 'block';
        }

        // Show specific image in preview (legacy function)
function showPreviewImage(type, index) {
    const previewInputImage = document.getElementById('previewInputImage');
    const previewOutputItems = document.querySelectorAll('.preview-output-item');
    
    // Remove active class from all items
    previewOutputItems.forEach(item => {
        item.classList.remove('active');
    });
    
    if (type === 'input') {
        // Highlight input image (we can't add class to input image container easily)
        // Instead, we'll scroll to top and ensure input image is visible
        const previewLeftPanel = document.querySelector('.preview-left-panel');
        if (previewLeftPanel) {
            previewLeftPanel.scrollTop = 0;
        }
    } else {
        // Highlight the clicked output image
        if (previewOutputItems[index]) {
            previewOutputItems[index].classList.add('active');
            // Scroll to make the active item visible
            previewOutputItems[index].scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest',
                inline: 'nearest'
            });
        }
    }
}

// Update navigation buttons state
function updatePreviewNavigationButtons() {
            const prevButton = document.getElementById('previewPrevBtn');
            const nextButton = document.getElementById('previewNextBtn');
            
            // Check if we're in 2-column view
            const previewLeftPanel = document.querySelector('.preview-left-panel');
            const previewRightPanel = document.querySelector('.preview-right-panel');
            const isTwoColumnView = previewLeftPanel && previewRightPanel && 
                                  previewLeftPanel.style.display !== 'none' && 
                                  previewRightPanel.style.display !== 'none';
            
            if (isTwoColumnView) {
                // In 2-column view: only enable next button (no < button)
                if (prevButton) prevButton.disabled = true;
                if (nextButton) nextButton.disabled = false;
            } else {
                // In single view: check current image type
                const currentImage = previewAllImages[previewCurrentImageIndex];
                
                if (currentImage && currentImage.type === 'input') {
                    // Input Image: < goes back to preview, > goes to next
                    if (prevButton) prevButton.disabled = false;
                    if (nextButton) nextButton.disabled = (previewAllImages.length <= 1);
                } else {
                    // Output Images: both buttons enabled
    if (prevButton) prevButton.disabled = false;
    if (nextButton) nextButton.disabled = false;
                }
            }
        }

        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
}

// Show full image from preview
function showPreviewFullImage(imageUrl, title) {
    // Instead of showing full image modal, navigate to the specific image in preview
    navigateToImage(imageUrl, title);
}

// Close preview full image modal
function closePreviewFullImage() {
    const fullImageModal = document.getElementById('previewFullImageModal');
    fullImageModal.style.display = 'none';
}

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
            
            // Restore body scroll
    document.body.style.overflow = 'auto';
}

        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Close modal with Escape key and navigation with arrow keys
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
                closePreviewModal();
                closePreviewFullImage();
                closeFullScreenModal();
            }
            
            // Navigation with arrow keys in preview modal
            if (document.getElementById('previewModal').style.display === 'block') {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigatePreviewImage(-1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigatePreviewImage(1);
                }
            }
            
            // Navigation with arrow keys in fullscreen modal
            if (document.getElementById('fullScreenModal').style.display === 'block') {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    showPreviousImage();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    showNextImage();
                }
            }
        });

        // Close preview modal when clicking outside the content
document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePreviewModal();
    }
});

        // Close preview full image modal when clicking outside the image
document.getElementById('previewFullImageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePreviewFullImage();
    }
});

        // Auto-resize textarea function
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }


        // Check if all form fields are completed
        function checkFormCompletion() {
            if (!currentQuestion) return;

            const submitButton = document.querySelector('.submit-button');
            let isComplete = true;

            // Check all rating inputs
            currentQuestion.outputs.forEach((output, index) => {
                const imageNumber = index + 1;
                const instruction = document.getElementById(`instruction-${imageNumber}`).value;
                const aesthetic = document.getElementById(`aesthetic-${imageNumber}`).value;
                const destruction = document.getElementById(`destruction-${imageNumber}`).value;

                if (!instruction || !aesthetic || !destruction) {
                    isComplete = false;
                }
            });

            // Enable/disable submit button
            submitButton.disabled = !isComplete;
        }

        // Add form completion check to rating inputs
        function addFormCompletionListeners() {
            if (!currentQuestion) return;

            currentQuestion.outputs.forEach((output, index) => {
                const imageNumber = index + 1;
                
                // Add listeners to all rating inputs
                ['instruction', 'aesthetic', 'destruction'].forEach(type => {
                    const input = document.getElementById(`${type}-${imageNumber}`);
                    if (input) {
                        input.addEventListener('input', checkFormCompletion);
                    }
                });
            });
}
</script>
</body>
</html>